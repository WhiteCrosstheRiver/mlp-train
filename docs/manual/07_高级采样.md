# 高级采样方法

mlp-train 提供了多种高级采样方法，用于探索构型空间和计算自由能。本章节介绍元动力学和伞形采样。

## 元动力学（Metadynamics）

元动力学是一种增强采样技术，通过在集体变量（CV）空间添加偏置势来促进构型空间探索。

### 基本使用

```python
import mlptrain as mlt
from mlptrain.sampling.plumed import PlumedAverageCV

# 定义集体变量（例如：两个原子间的平均距离）
cv = PlumedAverageCV(atom_idxs=[0, 1])

# 创建元动力学对象
metad = mlt.Metadynamics(cvs=[cv], temp=300)

# 运行元动力学模拟
metad.run_mlp_md(
    configuration=system.random_configuration(),
    mlp=gap,
    fs=10000,      # 模拟时间
    temp=300,
    dt=0.5,
    interval=10,
)
```

### 定义集体变量

#### 平均距离

```python
from mlptrain.sampling.plumed import PlumedAverageCV

cv = PlumedAverageCV(atom_idxs=[0, 1])  # 原子 0 和 1 之间的平均距离
```

#### 距离差

```python
from mlptrain.sampling.plumed import PlumedDifferenceCV

cv = PlumedDifferenceCV(
    atom_idxs1=[0, 1],  # 第一组原子
    atom_idxs2=[2, 3]   # 第二组原子
)
```

#### 配位数

```python
from mlptrain.sampling.plumed import PlumedCNCV

cv = PlumedCNCV(
    atom_idxs=[0],      # 中心原子
    r_0=2.5,            # 参考距离（Å）
    n=6,                # 配位数
    m=12                # 平滑参数
)
```

#### 自定义 CV

```python
from mlptrain.sampling.plumed import PlumedCustomCV

cv = PlumedCustomCV(
    plumed_cv_string="DISTANCE ATOMS=1,2"  # PLUMED 格式的 CV 定义
)
```

### 多 CV 元动力学

```python
cv1 = PlumedAverageCV(atom_idxs=[0, 1])
cv2 = PlumedAverageCV(atom_idxs=[2, 3])

metad = mlt.Metadynamics(cvs=[cv1, cv2], temp=300)
```

### 调整元动力学参数

```python
metad = mlt.Metadynamics(cvs=[cv], temp=300)

# 估计高斯宽度（自动）
metad.estimate_width(configurations=config_set, mlp=gap)

# 手动设置参数
metad.height = 0.1      # 高斯高度（eV）
metad.sigma = 0.1       # 高斯宽度（CV 单位）
metad.pace = 100        # 添加高斯的频率（步数）
```

### 良好调温元动力学（Well-Tempered Metadynamics）

```python
metad = mlt.Metadynamics(cvs=[cv], temp=300)

# 设置调温参数
metad.bias_factor = 10.0  # 偏置因子（越大，偏置增长越慢）

# 运行良好调温元动力学
metad.run_mlp_md(...)
```

### 分析元动力学结果

#### 绘制 CV 随时间变化

```python
from mlptrain.sampling.plumed import plot_cv_versus_time

plot_cv_versus_time('COLVAR')  # COLVAR 是 PLUMED 输出文件
```

#### 绘制 2D 自由能面

```python
from mlptrain.sampling.plumed import plot_cv1_and_cv2

plot_cv1_and_cv2('COLVAR', cv1_name='cv1', cv2_name='cv2')
```

#### 计算自由能

```python
# 从元动力学轨迹计算自由能
free_energy = metad.compute_free_energy(
    trajectory=trajectory,
    mlp=gap,
    method_name='orca'
)
```

## 伞形采样（Umbrella Sampling）

伞形采样通过在反应坐标的不同位置放置简谐偏置来系统地采样构型空间。

### 基本使用

```python
import mlptrain as mlt
from mlptrain.sampling.reaction_coord import AverageDistance

# 定义反应坐标
cv = AverageDistance(atom_idxs=[0, 1])

# 创建伞形采样对象
umbrella = mlt.UmbrellaSampling(
    cvs=[cv],
    temp=300
)

# 定义窗口（沿反应坐标的位置）
windows = [1.5, 2.0, 2.5, 3.0, 3.5]  # 距离值（Å）

# 运行伞形采样
umbrella.run(
    configurations=[system.random_configuration()] * len(windows),
    mlp=gap,
    windows=windows,
    kappas=[0.1] * len(windows),  # 弹簧常数（eV/Å²）
    fs=5000,                      # 每个窗口的模拟时间
    temp=300,
    dt=0.5,
    interval=10,
)
```

### 定义反应坐标

#### 平均距离

```python
from mlptrain.sampling.reaction_coord import AverageDistance

cv = AverageDistance(atom_idxs=[0, 1])
```

#### 距离差

```python
from mlptrain.sampling.reaction_coord import DifferenceDistance

cv = DifferenceDistance(
    atom_idxs1=[0, 1],
    atom_idxs2=[2, 3]
)
```

### 调整窗口参数

```python
# 不同窗口使用不同的弹簧常数
kappas = [0.2, 0.15, 0.1, 0.15, 0.2]  # 窗口边缘使用更大的弹簧常数

umbrella.run(
    ...,
    windows=windows,
    kappas=kappas,
)
```

### 使用 WHAM 分析

加权直方图分析方法（WHAM）用于从伞形采样数据计算自由能：

```python
# 运行伞形采样后
umbrella.run(...)

# 使用 WHAM 计算自由能
free_energy = umbrella.compute_free_energy(method='wham')
```

### 使用 UI 分析

非平衡积分方法（UI）是另一种分析伞形采样数据的方法：

```python
free_energy = umbrella.compute_free_energy(method='ui')
```

### 绘制自由能曲线

```python
# 计算自由能后
free_energy = umbrella.compute_free_energy(method='wham')

# 绘制
umbrella.plot_free_energy()
```

## 在主动学习中使用高级采样

### 元动力学辅助的主动学习

```python
from mlptrain.sampling import PlumedBias
from mlptrain.sampling.plumed import PlumedAverageCV

# 定义 CV
cv = PlumedAverageCV(atom_idxs=[0, 1])

# 创建 PLUMED 偏置
bias = PlumedBias(cvs=[cv])

# 在主动学习中使用
gap.al_train(
    method_name='orca',
    temp=1000,
    bias=bias,
    inherit_metad_bias=True  # 继承元动力学偏置
)
```

### 伞形采样辅助的主动学习

```python
from mlptrain.sampling import Bias
from mlptrain.sampling.reaction_coord import AverageDistance

# 定义反应坐标
cv = AverageDistance(atom_idxs=[0, 1])

# 创建偏置
bias = Bias(cv, kappa=0.1, ref=2.0)

# 在主动学习中使用
gap.al_train(
    method_name='orca',
    temp=1000,
    bias=bias,
    bias_start_iter=5  # 从第 5 次迭代开始应用偏置
)
```

## 组合使用

### 元动力学 + 伞形采样

可以先用元动力学探索构型空间，然后用伞形采样精确计算自由能：

```python
# 1. 元动力学探索
metad = mlt.Metadynamics(cvs=[cv], temp=300)
metad.run_mlp_md(...)

# 2. 从元动力学轨迹确定窗口位置
# （手动分析或自动检测）

# 3. 伞形采样精确计算
umbrella = mlt.UmbrellaSampling(cvs=[cv], temp=300)
umbrella.run(...)
```

## 最佳实践

### 元动力学

1. **选择合适的 CV**：
   - CV 应该能够区分不同的状态
   - 避免使用快变量作为 CV

2. **调整参数**：
   - 使用 `estimate_width()` 自动估计高斯宽度
   - 对于良好调温元动力学，选择合适的偏置因子

3. **监控模拟**：
   - 检查 CV 是否充分采样
   - 确保偏置不会过度增长

### 伞形采样

1. **窗口间距**：
   - 窗口之间应该有足够的重叠
   - 通常间距为 0.2-0.5 Å（对于距离 CV）

2. **弹簧常数**：
   - 足够大以限制采样范围
   - 但不要太大，以免限制构型探索

3. **模拟时间**：
   - 每个窗口至少需要几千步
   - 确保在每个窗口内充分采样

## 常见问题

### 问题 1：元动力学偏置增长过快

**解决方案**：
- 使用良好调温元动力学
- 增加偏置因子
- 减小高斯高度

### 问题 2：伞形采样窗口重叠不足

**解决方案**：
- 减小窗口间距
- 增加弹簧常数
- 增加模拟时间

### 问题 3：自由能计算不收敛

**解决方案**：
- 增加每个窗口的模拟时间
- 检查窗口是否有足够的重叠
- 尝试不同的分析方法（WHAM vs UI）

## 下一步

- 查看 [配置系统](08_配置系统.md) 了解如何自定义参数
- 参考 [示例教程](09_示例教程.md) 查看实际应用
