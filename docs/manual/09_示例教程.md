# 示例教程

本章节详细介绍 mlp-train 提供的各种示例，帮助您理解如何在实际应用中使用该包。

## 基础示例

### 1. 水分子（water.py）

最简单的示例，演示如何使用 GAP 训练水分子势能。

**文件位置**：`examples/water.py`

**关键特性**：
- 使用 ACE 模型
- 使用 SOAP 描述符和原子环境相似性选择器
- 运行 MD 模拟

**代码要点**：
```python
import mlptrain as mlt
from mlptrain.training.selection import AtomicEnvSimilarity
from mlptrain.descriptor import SoapDescriptor

mlt.Config.n_cores = 10
system = mlt.System(mlt.Molecule('water.xyz'), box=None)
ace = mlt.potentials.ACE('water', system=system)

# 使用自定义描述符和选择器
descriptor = SoapDescriptor(average='outer', r_cut=6.0, n_max=6, l_max=6)
selector = AtomicEnvSimilarity(descriptor=descriptor, threshold=0.9995)
ace.al_train(method_name='xtb', selection_method=selector, temp=500)

# 运行 MD
trajectory = mlt.md.run_mlp_md(
    configuration=system.random_configuration(),
    mlp=ace,
    fs=200,
    temp=300,
    dt=0.5,
    interval=10,
)
trajectory.save(filename='water_trajectory.xyz')
```

### 2. 甲烷（methane.py）

演示使用 GAP 训练简单分子。

**文件位置**：`examples/methane.py`

**关键特性**：
- 使用 GAP 模型
- 使用 ORCA 作为参考方法
- 轨迹比较和可视化

**代码要点**：
```python
import mlptrain as mlt

mlt.Config.n_cores = 10
mlt.Config.orca_keywords = ['PBE', 'def2-SVP', 'EnGrad']

system = mlt.System(mlt.Molecule('methane.xyz'), box=None)
gap = mlt.potentials.GAP('methane', system=system)

# 主动学习训练
gap.al_train(method_name='orca', temp=1000)

# 运行 MD
trajectory = mlt.md.run_mlp_md(
    configuration=system.random_configuration(),
    mlp=gap,
    fs=200,
    temp=300,
    dt=0.5,
    interval=10,
)

# 比较预测与真实值
trajectory.compare(gap, 'orca')
```

### 3. 水分子（OpenMM）（water_openmm.py）

演示如何使用 OpenMM 后端运行 MD 模拟。

**文件位置**：`examples/water_openmm.py`

**关键特性**：
- 使用 MACE 模型
- 使用 OpenMM 进行 MD 模拟
- 在主动学习中使用 OpenMM

**代码要点**：
```python
import mlptrain as mlt

mlt.Config.n_cores = 1
system = mlt.System(mlt.Molecule('water.xyz'), box=None)
mace = mlt.potentials.MACE('water', system=system)

# 使用 OpenMM 进行主动学习
mace.al_train(
    method_name='xtb',
    temp=500,
    max_active_iters=2,
    max_active_time=50,
    n_configs_iter=3,
    md_program='OpenMM',
)

# 使用 OpenMM 运行 MD
trajectory = mlt.md_openmm.run_mlp_md_openmm(
    configuration=system.random_configuration(),
    mlp=mace,
    fs=2000,
    temp=300,
    dt=0.5,
    interval=100,
)
trajectory.save(filename='water_trajectory.xyz')
```

## 反应示例

### 4. Diels-Alder 反应（da_ts.py）

演示如何训练反应过渡态的势能。

**文件位置**：`examples/da_ts.py`

**关键特性**：
- 过渡态结构训练
- 使用原子环境相似性选择器
- 固定初始构型

**代码要点**：
```python
import mlptrain as mlt

mlt.Config.n_cores = 10
mlt.Config.orca_keywords = ['PBE0', 'def2-SVP', 'EnGrad']

system = mlt.System(mlt.Molecule('da_ts.xyz'), box=None)
gap = mlt.potentials.GAP('da', system=system)

gap.al_train(
    method_name='orca',
    temp=300,  # 较低温度，适合过渡态
    selection_method=mlt.selection.AtomicEnvSimilarity(),
    max_active_time=200,
    fix_init_config=True,  # 固定初始构型
)

# 运行低温 MD 验证
trajectory = mlt.md.run_mlp_md(
    configuration=system.configuration,
    mlp=gap,
    fs=300,
    temp=100,  # 低温
    dt=0.5,
    interval=10,
)

trajectory.compare(gap, 'orca')
```

## 高级采样示例

### 5. 元动力学（metadynamics/）

演示如何使用元动力学进行增强采样。

**目录位置**：`examples/metadynamics/`

#### H₂ 系统（h2/h2.py）

**关键特性**：
- 简单双原子系统
- 一维元动力学
- 自由能计算

#### H₂O 系统（h2o/h2o.py）

**关键特性**：
- 三原子系统
- 多 CV 元动力学
- 自由能面计算

### 6. 伞形采样（umbrella/）

演示如何使用伞形采样计算自由能。

**目录位置**：`examples/umbrella/`

**关键特性**：
- 定义反应坐标
- 设置多个窗口
- WHAM 分析

**代码结构**：
```python
import mlptrain as mlt
from mlptrain.sampling.reaction_coord import AverageDistance

# 定义反应坐标
cv = AverageDistance(atom_idxs=[0, 1])

# 创建伞形采样对象
umbrella = mlt.UmbrellaSampling(cvs=[cv], temp=300)

# 定义窗口
windows = [1.5, 2.0, 2.5, 3.0, 3.5]
kappas = [0.1] * len(windows)

# 运行伞形采样
umbrella.run(
    configurations=[...],
    mlp=gap,
    windows=windows,
    kappas=kappas,
    fs=5000,
    temp=300,
    dt=0.5,
    interval=10,
)

# 计算自由能
free_energy = umbrella.compute_free_energy(method='wham')
```

## 论文示例

### 7. DA 论文示例（DA_paper/）

包含 Diels-Alder 反应研究的完整示例。

**目录位置**：`examples/DA_paper/`

**子目录**：
- `training/`：训练脚本
- `uphill/`：上坡采样
- `1d_fes/`：一维自由能面
- `2D_pes/`：二维势能面

### 8. WTMetaD 论文示例（WTMetaD_paper/）

包含良好调温元动力学研究的示例。

**目录位置**：`examples/WTMetaD_paper/`

**关键特性**：
- 良好调温元动力学
- 自由能计算
- 主动学习结合

### 9. 继承偏置主动学习（inherited_bias_active_learning/）

演示如何在主动学习中继承元动力学偏置。

**目录位置**：`examples/inherited_bias_active_learning/`

**关键特性**：
- 元动力学偏置继承
- 加速构型空间探索
- 提高训练效率

## 运行示例

### 基本步骤

1. **进入示例目录**：
   ```bash
   cd examples
   ```

2. **准备输入文件**：
   - 确保所需的 XYZ 文件存在
   - 检查量子化学软件配置

3. **激活环境**：
   ```bash
   conda activate mlp-train-gap  # 或其他模型环境
   ```

4. **运行脚本**：
   ```bash
   python water.py
   ```

### 修改示例

在运行示例前，您可能需要：

1. **调整核心数**：
   ```python
   mlt.Config.n_cores = 4  # 根据您的系统调整
   ```

2. **修改参考方法**：
   ```python
   # 如果 ORCA 未安装，使用 xTB
   gap.al_train(method_name='xtb', temp=500)
   ```

3. **减少迭代次数**（用于测试）：
   ```python
   gap.al_train(
       method_name='xtb',
       temp=500,
       max_active_iters=2,  # 减少迭代次数
       n_configs_iter=3,     # 减少每次迭代的构型数
   )
   ```

## 示例选择指南

根据您的需求选择合适的示例：

- **初学者**：从 `water.py` 或 `methane.py` 开始
- **反应研究**：查看 `da_ts.py` 和 `DA_paper/`
- **自由能计算**：参考 `metadynamics/` 和 `umbrella/`
- **大规模系统**：使用 `water_openmm.py`（MACE + OpenMM）
- **高级应用**：查看 `paper_examples/` 和 `WTMetaD_paper/`

## 常见问题

### 问题 1：示例无法运行

**可能原因**：
- 缺少输入文件
- 量子化学软件未配置
- 环境未激活

**解决方案**：
1. 检查输入文件是否存在
2. 验证软件配置
3. 确保激活了正确的 conda 环境

### 问题 2：计算时间过长

**解决方案**：
- 减少 `max_active_iters`
- 减少 `n_configs_iter`
- 使用更快的参考方法（如 xTB）

### 问题 3：内存不足

**解决方案**：
- 减少 `n_configs_iter`
- 使用更小的系统进行测试
- 减少并行核心数

## 下一步

- 查看 [API 参考](10_API参考.md) 了解详细 API
- 参考 [最佳实践](12_最佳实践.md) 优化您的使用
