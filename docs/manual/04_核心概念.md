# 核心概念

理解 mlp-train 的核心概念对于有效使用该包至关重要。本章节介绍主要的数据结构和类。

## 主要类

### Molecule（分子）

`Molecule` 类表示一个分子，可以从 XYZ 文件读取或直接创建。

```python
import mlptrain as mlt

# 从文件读取
molecule = mlt.Molecule('water.xyz')

# 带电荷和自旋多重度
molecule = mlt.Molecule('water.xyz', charge=0, mult=1)
```

**主要属性**：
- `atoms`：原子列表
- `charge`：电荷
- `mult`：自旋多重度

### System（系统）

`System` 类表示一个完整的系统，包含分子和可能的周期性边界条件。

```python
# 无周期性边界条件（气相）
system = mlt.System(mlt.Molecule('water.xyz'), box=None)

# 有周期性边界条件（溶液相）
box = mlt.Box([20.0, 20.0, 20.0])  # 20 Å × 20 Å × 20 Å 的盒子
system = mlt.System(mlt.Molecule('water.xyz'), box=box)
```

**主要方法**：
- `random_configuration()`：生成随机构型
- `configuration()`：生成特定构型

### Configuration（构型）

`Configuration` 类表示系统在某一时刻的原子构型，包含位置、能量、力等信息。

```python
# 从系统生成随机构型
config = system.random_configuration()

# 从 XYZ 文件读取
config = mlt.Configuration.from_xyz('structure.xyz')

# 手动创建
config = mlt.Configuration(
    atoms=[...],  # 原子列表
    charge=0,
    mult=1,
    box=None
)
```

**主要属性**：
- `atoms`：原子列表
- `energy`：能量（Energy 对象）
- `forces`：力（Forces 对象）
- `box`：周期性盒子（Box 对象）
- `charge`：电荷
- `mult`：自旋多重度

**主要方法**：
- `save_xyz(filename)`：保存为 XYZ 格式
- `energy.true`：真实能量值
- `energy.predicted`：MLP 预测的能量值

### ConfigurationSet（构型集合）

`ConfigurationSet` 类用于管理多个构型，通常用于训练数据集。

```python
# 创建空集合
config_set = mlt.ConfigurationSet()

# 添加构型
config_set += config1
config_set += config2

# 或使用列表
config_set = mlt.ConfigurationSet([config1, config2, config3])

# 从文件加载
config_set = mlt.ConfigurationSet.from_xyz('trajectory.xyz')
```

**主要方法**：
- `save_xyz(filename)`：保存所有构型
- `remove_above_e(threshold)`：移除能量高于阈值的构型
- `has_a_none_energy`：检查是否有未计算能量的构型

### Trajectory（轨迹）

`Trajectory` 类表示分子动力学轨迹，是 `ConfigurationSet` 的子类，但包含时间信息。

```python
# 从 MD 模拟生成
trajectory = mlt.md.run_mlp_md(...)

# 从文件加载
trajectory = mlt.Trajectory.from_xyz('trajectory.xyz')

# 访问构型
first_config = trajectory[0]
last_config = trajectory[-1]

# 迭代
for config in trajectory:
    print(config.energy.true)
```

**主要方法**：
- `save(filename)`：保存轨迹
- `compare(mlp, method_name)`：比较 MLP 预测与真实值
- `plot()`：绘制轨迹

### Box（盒子）

`Box` 类表示周期性边界条件的盒子。

```python
# 立方盒子
box = mlt.Box([20.0, 20.0, 20.0])

# 非立方盒子
box = mlt.Box([20.0, 25.0, 30.0])
```

### MLPotential（机器学习势能）

`MLPotential` 是所有 MLP 模型的基类。具体实现包括：

- `mlt.potentials.GAP`
- `mlt.potentials.ACE`
- `mlt.potentials.MACE`

```python
# 创建 GAP 势能
gap = mlt.potentials.GAP('water', system=system)

# 创建 ACE 势能
ace = mlt.potentials.ACE('water', system=system)

# 创建 MACE 势能
mace = mlt.potentials.MACE('water', system=system)
```

**主要属性**：
- `name`：势能名称
- `system`：关联的系统
- `training_data`：训练数据集（ConfigurationSet）

**主要方法**：
- `al_train(...)`：主动学习训练
- `train(configurations)`：使用给定数据集训练
- `predict(configuration)`：预测能量和力
- `save()`：保存训练好的势能
- `load()`：加载已保存的势能

## 能量和力

### Energy（能量）

`Energy` 类存储构型的能量信息。

```python
config.energy.true        # 真实能量（从量子化学计算）
config.energy.predicted   # MLP 预测的能量
config.energy.delta       # 误差（predicted - true）
```

### Forces（力）

`Forces` 类存储构型的力信息。

```python
config.forces.true        # 真实力（从量子化学计算）
config.forces.predicted   # MLP 预测的力
config.forces.delta       # 误差
```

## 数据流

典型的 mlp-train 工作流如下：

```
Molecule → System → Configuration → ConfigurationSet → MLPotential
                                                              ↓
                                                         Trajectory
```

1. **Molecule**：定义分子结构
2. **System**：定义完整系统（可能包含溶剂）
3. **Configuration**：系统在某一时刻的构型
4. **ConfigurationSet**：多个构型的集合（训练数据）
5. **MLPotential**：训练好的机器学习势能
6. **Trajectory**：MD 模拟生成的轨迹

## 示例：完整工作流

```python
import mlptrain as mlt

# 1. 创建分子和系统
molecule = mlt.Molecule('water.xyz')
system = mlt.System(molecule, box=None)

# 2. 创建 MLP
gap = mlt.potentials.GAP('water', system=system)

# 3. 主动学习训练（内部生成 ConfigurationSet）
gap.al_train(method_name='orca', temp=1000)

# 4. 生成起始构型
config = system.random_configuration()

# 5. 运行 MD 模拟生成轨迹
trajectory = mlt.md.run_mlp_md(
    configuration=config,
    mlp=gap,
    fs=200,
    temp=300,
    dt=0.5,
    interval=10,
)

# 6. 分析轨迹
trajectory.compare(gap, 'orca')
trajectory.save('water_trajectory.xyz')
```

## 下一步

- 学习 [MLP 训练](05_MLP训练.md) 的详细内容
- 了解 [分子动力学模拟](06_分子动力学.md) 的使用方法
