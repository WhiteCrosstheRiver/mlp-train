# 安装指南

## 系统要求

- **操作系统**：Linux、macOS 或 Windows（WSL2）
- **Python**：>= 3.8
- **Conda**：推荐使用 conda 进行环境管理
- **Julia**：仅在使用 ACE 模型时需要（版本 >= 1.6）

## 安装步骤

### 1. 克隆仓库

```bash
git clone https://github.com/duartegroup/mlp-train.git
cd mlp-train
```

### 2. 安装 MLP 模型

mlp-train 为每个模型提供了独立的安装脚本，每个模型会安装到独立的 conda 环境中。

#### 安装 GAP

```bash
./install_gap.sh
```

这将创建一个名为 `mlp-train-gap` 的 conda 环境。

#### 安装 ACE

```bash
./install_ace.sh
```

**注意**：ACE 安装需要 Julia（版本 >= 1.6），且 Julia 必须在 `$PATH` 中可用。

这将创建一个名为 `mlp-train-ace` 的 conda 环境。

#### 安装 MACE

```bash
./install_mace.sh
```

**CUDA 支持**：MACE 安装支持 CUDA 加速。根据您的机器配置，可能需要指定 CUDA 版本：

```bash
CONDA_OVERRIDE_CUDA="11.2" ./install_mace.sh
```

这在以下两种情况下特别有用：
- 确保环境与您的 CUDA 驱动兼容
- 在无 GPU 的节点上安装，但计划在 GPU 节点上运行（强制安装 CUDA 构建）

这将创建一个名为 `mlp-train-mace` 的 conda 环境。

### 3. 激活环境

根据您要使用的模型，激活相应的环境：

```bash
# 使用 GAP
conda activate mlp-train-gap

# 使用 ACE
conda activate mlp-train-ace

# 使用 MACE
conda activate mlp-train-mace
```

## 验证安装

安装完成后，可以通过以下方式验证：

```python
import mlptrain as mlt
print(mlt.__version__)
```

如果能够成功导入并显示版本号，说明安装成功。

## 安装 OpenMM 支持

OpenMM 后端目前仅与 MACE 配合工作。MACE 安装过程中会自动安装必要的依赖。

安装完成后，您可以运行 `examples/water_openmm.py` 来测试 OpenMM 功能。

## 依赖说明

### 核心依赖

- `numpy`
- `ase` (Atomic Simulation Environment)
- `autode`
- `scipy`

### 模型特定依赖

- **GAP**: `quippy` (QUIP 包)
- **ACE**: `julia` (>= 1.6), `ACE1.jl`
- **MACE**: `torch`, `mace-torch`

### 可选依赖

- **OpenMM**: 用于 OpenMM 后端（仅 MACE）
- **PLUMED**: 用于高级采样方法

## 常见问题

### 问题 1：Julia 未找到

**症状**：安装 ACE 时提示找不到 Julia

**解决方案**：
1. 确保已安装 Julia（版本 >= 1.6）
2. 确保 Julia 在系统 PATH 中：
   ```bash
   which julia
   ```
3. 如果未找到，将 Julia 添加到 PATH：
   ```bash
   export PATH=$PATH:/path/to/julia/bin
   ```

### 问题 2：CUDA 相关错误

**症状**：MACE 安装时出现 CUDA 相关错误

**解决方案**：
1. 检查 CUDA 驱动版本：
   ```bash
   nvidia-smi
   ```
2. 使用 `CONDA_OVERRIDE_CUDA` 指定兼容的 CUDA 版本
3. 如果不需要 GPU，可以安装 CPU 版本

### 问题 3：权限错误

**症状**：安装脚本无法执行

**解决方案**：
```bash
chmod +x install_*.sh
```

### 问题 4：conda 环境冲突

**症状**：环境创建失败或依赖冲突

**解决方案**：
1. 确保使用最新的 conda
2. 清理 conda 缓存：
   ```bash
   conda clean --all
   ```
3. 尝试使用 `--force` 选项重新创建环境

## 开发者安装

如果您想为项目贡献代码，需要安装开发依赖：

```bash
# 在激活的环境中
pip install -e ".[docs]"
pre-commit install
```

这将安装：
- 开发模式下的包
- 文档生成工具
- 代码检查工具（pre-commit, Ruff）

## 下一步

安装完成后，请查看 [快速开始指南](03_快速开始.md) 来开始使用 mlp-train。
