<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mlp-train 使用手册</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Pygments 代码高亮样式 */
        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #f8f8f8; }
.highlight .c { color: #3D7B7B; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #F00 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666 } /* Operator */
.highlight .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #9C6500 } /* Comment.Preproc */
.highlight .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.highlight .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #E40000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #008400 } /* Generic.Inserted */
.highlight .go { color: #717171 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #04D } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #687822 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #00F; font-weight: bold } /* Name.Class */
.highlight .no { color: #800 } /* Name.Constant */
.highlight .nd { color: #A2F } /* Name.Decorator */
.highlight .ni { color: #717171; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #00F } /* Name.Function */
.highlight .nl { color: #767600 } /* Name.Label */
.highlight .nn { color: #00F; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #A2F; font-weight: bold } /* Operator.Word */
.highlight .w { color: #BBB } /* Text.Whitespace */
.highlight .mb { color: #666 } /* Literal.Number.Bin */
.highlight .mf { color: #666 } /* Literal.Number.Float */
.highlight .mh { color: #666 } /* Literal.Number.Hex */
.highlight .mi { color: #666 } /* Literal.Number.Integer */
.highlight .mo { color: #666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #A45A77 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #00F } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666 } /* Literal.Number.Integer.Long */
    </style>
</head>
<body>
    <header class="header">
        <h1>mlp-train 使用手册</h1>
        <div class="search-box">
            <input type="text" id="search-input" placeholder="搜索内容...">
        </div>
    </header>
    
    <div class="container">
        <nav class="sidebar">
            <h2>目录</h2>
            <ul>
    <li><a href="#section-0">项目介绍</a></li>
    <li><a href="#section-1">安装指南</a></li>
    <li><a href="#section-2">快速开始</a></li>
    <li><a href="#section-3">核心概念</a></li>
    <li><a href="#section-4">MLP 训练</a></li>
    <li><a href="#section-5">分子动力学模拟</a></li>
    <li><a href="#section-6">高级采样方法</a></li>
    <li><a href="#section-7">配置系统</a></li>
    <li><a href="#section-8">示例教程</a></li>
    <li><a href="#section-9">API 参考</a></li>
    <li><a href="#section-10">常见问题</a></li>
    <li><a href="#section-11">最佳实践</a></li>
</ul>
        </nav>
        
        <main class="content">
            <section class="section" id="readme">
                <h1 id="mlp-train">mlp-train 使用手册<a class="headerlink" href="#mlp-train" title="Permanent link">&para;</a></h1>
<p>欢迎使用 mlp-train 使用手册！本手册提供了 mlp-train 的完整使用指南，从基础概念到高级应用，帮助您快速上手并深入使用该包。</p>
<h2 id="_1">手册目录<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="_2">基础部分<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ol>
<li><strong><a href="01_项目介绍.md">项目介绍</a></strong></li>
<li>什么是 mlp-train</li>
<li>支持的模型</li>
<li>
<p>应用场景</p>
</li>
<li>
<p><strong><a href="02_安装指南.md">安装指南</a></strong></p>
</li>
<li>系统要求</li>
<li>安装步骤</li>
<li>
<p>常见问题</p>
</li>
<li>
<p><strong><a href="03_快速开始.md">快速开始</a></strong></p>
</li>
<li>最简单的例子</li>
<li>代码解释</li>
<li>下一步</li>
</ol>
<h3 id="_3">核心功能<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<ol>
<li><strong><a href="04_核心概念.md">核心概念</a></strong></li>
<li>主要类</li>
<li>数据流</li>
<li>
<p>示例</p>
</li>
<li>
<p><strong><a href="05_MLP训练.md">MLP 训练</a></strong></p>
</li>
<li>主动学习概述</li>
<li>训练参数</li>
<li>
<p>选择方法</p>
</li>
<li>
<p><strong><a href="06_分子动力学.md">分子动力学</a></strong></p>
</li>
<li>基本 MD 模拟</li>
<li>ASE 和 OpenMM</li>
<li>
<p>轨迹分析</p>
</li>
<li>
<p><strong><a href="07_高级采样.md">高级采样</a></strong></p>
</li>
<li>元动力学</li>
<li>伞形采样</li>
<li>组合使用</li>
</ol>
<h3 id="_4">高级主题<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ol>
<li><strong><a href="08_配置系统.md">配置系统</a></strong></li>
<li>Config 类</li>
<li>模型参数</li>
<li>
<p>自定义配置</p>
</li>
<li>
<p><strong><a href="09_示例教程.md">示例教程</a></strong></p>
</li>
<li>基础示例</li>
<li>反应示例</li>
<li>
<p>高级采样示例</p>
</li>
<li>
<p><strong><a href="10_API参考.md">API 参考</a></strong></p>
<ul>
<li>核心类</li>
<li>主要函数</li>
<li>参数说明</li>
</ul>
</li>
<li>
<p><strong><a href="11_常见问题.md">常见问题</a></strong></p>
<ul>
<li>安装问题</li>
<li>配置问题</li>
<li>训练问题</li>
</ul>
</li>
<li>
<p><strong><a href="12_最佳实践.md">最佳实践</a></strong></p>
<ul>
<li>训练策略</li>
<li>性能优化</li>
<li>代码组织</li>
</ul>
</li>
</ol>
<h2 id="_5">快速导航<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">我是初学者<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>建议按以下顺序阅读：<br />
1. 项目介绍<br />
2. 安装指南<br />
3. 快速开始<br />
4. 核心概念<br />
5. MLP 训练<br />
6. 分子动力学</p>
<h3 id="_7">我想解决特定问题<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>安装问题</strong> → <a href="02_安装指南.md">安装指南</a> 或 <a href="11_常见问题.md">常见问题</a></li>
<li><strong>训练问题</strong> → <a href="05_MLP训练.md">MLP 训练</a> 或 <a href="11_常见问题.md">常见问题</a></li>
<li><strong>MD 模拟问题</strong> → <a href="06_分子动力学.md">分子动力学</a></li>
<li><strong>自由能计算</strong> → <a href="07_高级采样.md">高级采样</a></li>
</ul>
<h3 id="_8">我想深入学习<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<ul>
<li><a href="10_API参考.md">API 参考</a> - 了解所有 API</li>
<li><a href="09_示例教程.md">示例教程</a> - 查看实际应用</li>
<li><a href="12_最佳实践.md">最佳实践</a> - 优化使用</li>
</ul>
<h2 id="_9">使用建议<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>从基础开始</strong>：如果您是第一次使用，建议从"快速开始"开始</li>
<li><strong>实践为主</strong>：结合示例代码进行实践</li>
<li><strong>查阅文档</strong>：遇到问题时查阅相关章节</li>
<li><strong>参考示例</strong>：查看 examples 目录中的示例代码</li>
</ol>
<h2 id="_10">获取帮助<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>GitHub Issues</strong>：https://github.com/duartegroup/mlp-train/issues</li>
<li><strong>项目文档</strong>：https://mlp-train.readthedocs.io/en/latest/index.html</li>
<li><strong>教程</strong>：https://github.com/duartegroup/euchems_tutorial</li>
</ul>
<h2 id="_11">贡献<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>如果您发现手册中的错误或有改进建议，欢迎提交 Issue 或 Pull Request。</p>
<hr />
<p><strong>祝您使用愉快！</strong></p>
            </section>
            
            <section id="section-0" class="section">
                <h1 id="_1">项目介绍<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="mlp-train">什么是 mlp-train？<a class="headerlink" href="#mlp-train" title="Permanent link">&para;</a></h2>
<p>mlp-train 是一个用于训练机器学习势能（Machine Learning Potential, MLP）的 Python 包，由牛津大学 Duarte 课题组开发。它专门用于气相和溶液相分子系统的机器学习势能训练。</p>
<h2 id="_2">主要功能<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>mlp-train 提供了完整的机器学习势能训练工作流，包括：</p>
<ul>
<li><strong>主动学习（Active Learning）</strong>：自动生成训练数据集</li>
<li><strong>多种 MLP 模型支持</strong>：GAP、ACE、MACE</li>
<li><strong>分子动力学模拟</strong>：支持 ASE 和 OpenMM 两种引擎</li>
<li><strong>高级采样方法</strong>：元动力学、伞形采样等</li>
<li><strong>灵活的配置系统</strong>：易于定制和扩展</li>
</ul>
<h2 id="_3">支持的机器学习势能模型<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="1-gap-gaussian-approximation-potential">1. GAP (Gaussian Approximation Potential)<a class="headerlink" href="#1-gap-gaussian-approximation-potential" title="Permanent link">&para;</a></h3>
<ul>
<li>基于高斯过程的势能模型</li>
<li>使用 SOAP 描述符</li>
<li>适合中小型系统</li>
</ul>
<h3 id="2-ace-atomic-cluster-expansion">2. ACE (Atomic Cluster Expansion)<a class="headerlink" href="#2-ace-atomic-cluster-expansion" title="Permanent link">&para;</a></h3>
<ul>
<li>基于原子簇展开的势能模型</li>
<li>需要 Julia 环境（版本 &gt;= 1.6）</li>
<li>高性能，适合大规模系统</li>
</ul>
<h3 id="3-mace-multi-ace">3. MACE (Multi-ACE)<a class="headerlink" href="#3-mace-multi-ace" title="Permanent link">&para;</a></h3>
<ul>
<li>基于多体 ACE 的神经网络势能</li>
<li>支持 CUDA 加速</li>
<li>适合复杂系统</li>
</ul>
<h2 id="_4">单位系统<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>mlp-train 使用以下单位系统：</p>
<ul>
<li><strong>距离</strong>：Å（埃）</li>
<li><strong>能量</strong>：eV（电子伏特）</li>
<li><strong>力</strong>：eV Å⁻¹</li>
<li><strong>时间</strong>：fs（飞秒）</li>
</ul>
<h2 id="_5">应用场景<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<p>mlp-train 适用于：</p>
<ul>
<li>反应动力学研究</li>
<li>自由能面计算</li>
<li>过渡态搜索</li>
<li>长时间尺度分子动力学模拟</li>
<li>溶液相反应研究</li>
</ul>
<h2 id="_6">引用<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p>如果您在研究中使用了 mlp-train，请考虑引用以下论文：</p>
<div class="highlight"><pre><span></span><code><span class="nv">@article</span><span class="err">{</span><span class="n">MLPTraining2022</span><span class="p">,</span>
<span class="w">  </span><span class="n">doi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="mf">10.1039</span><span class="o">/</span><span class="n">D2CP02978B</span><span class="err">}</span><span class="p">,</span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">doi</span><span class="p">.</span><span class="n">org</span><span class="o">/</span><span class="mf">10.1039</span><span class="o">/</span><span class="n">D2CP02978B</span><span class="err">}</span><span class="p">,</span>
<span class="w">  </span><span class="nf">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="mi">2022</span><span class="err">}</span><span class="p">,</span>
<span class="w">  </span><span class="n">publisher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">The</span><span class="w"> </span><span class="n">Royal</span><span class="w"> </span><span class="n">Society</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Chemistry</span><span class="err">}</span><span class="p">,</span>
<span class="w">  </span><span class="n">author</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">Young</span><span class="p">,</span><span class="w"> </span><span class="n">Tom</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Johnston</span><span class="o">-</span><span class="n">Wood</span><span class="p">,</span><span class="w"> </span><span class="n">Tristan</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Zhang</span><span class="p">,</span><span class="w"> </span><span class="n">Hanwen</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">Duarte</span><span class="p">,</span><span class="w"> </span><span class="n">Fernanda</span><span class="err">}</span><span class="p">,</span>
<span class="w">  </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">Reaction</span><span class="w"> </span><span class="n">dynamics</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">Diels</span><span class="o">-</span><span class="n">Alder</span><span class="w"> </span><span class="n">reactions</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">learned</span><span class="w"> </span><span class="n">potentials</span><span class="err">}</span><span class="p">,</span>
<span class="w">  </span><span class="n">journal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="n">Phys</span><span class="p">.</span><span class="w"> </span><span class="n">Chem</span><span class="p">.</span><span class="w"> </span><span class="n">Chem</span><span class="p">.</span><span class="w"> </span><span class="n">Phys</span><span class="p">.</span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div>

<h2 id="_7">项目链接<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>GitHub</strong>: https://github.com/duartegroup/mlp-train</li>
<li><strong>文档</strong>: https://mlp-train.readthedocs.io/en/latest/index.html</li>
<li><strong>教程</strong>: https://github.com/duartegroup/euchems_tutorial</li>
</ul>
<h2 id="_8">许可证<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>本项目采用 MIT 2.0 许可证。</p>
            </section>

            <section id="section-1" class="section">
                <h1 id="_1">安装指南<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="_2">系统要求<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ul>
<li><strong>操作系统</strong>：Linux、macOS 或 Windows（WSL2）</li>
<li><strong>Python</strong>：&gt;= 3.8</li>
<li><strong>Conda</strong>：推荐使用 conda 进行环境管理</li>
<li><strong>Julia</strong>：仅在使用 ACE 模型时需要（版本 &gt;= 1.6）</li>
</ul>
<h2 id="_3">安装步骤<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="1">1. 克隆仓库<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/duartegroup/mlp-train.git
<span class="nb">cd</span><span class="w"> </span>mlp-train
</code></pre></div>

<h3 id="2-mlp">2. 安装 MLP 模型<a class="headerlink" href="#2-mlp" title="Permanent link">&para;</a></h3>
<p>mlp-train 为每个模型提供了独立的安装脚本，每个模型会安装到独立的 conda 环境中。</p>
<h4 id="gap">安装 GAP<a class="headerlink" href="#gap" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>./install_gap.sh
</code></pre></div>

<p>这将创建一个名为 <code>mlp-train-gap</code> 的 conda 环境。</p>
<h4 id="ace">安装 ACE<a class="headerlink" href="#ace" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>./install_ace.sh
</code></pre></div>

<p><strong>注意</strong>：ACE 安装需要 Julia（版本 &gt;= 1.6），且 Julia 必须在 <code>$PATH</code> 中可用。</p>
<p>这将创建一个名为 <code>mlp-train-ace</code> 的 conda 环境。</p>
<h4 id="mace">安装 MACE<a class="headerlink" href="#mace" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code>./install_mace.sh
</code></pre></div>

<p><strong>CUDA 支持</strong>：MACE 安装支持 CUDA 加速。根据您的机器配置，可能需要指定 CUDA 版本：</p>
<div class="highlight"><pre><span></span><code><span class="nv">CONDA_OVERRIDE_CUDA</span><span class="o">=</span><span class="s2">&quot;11.2&quot;</span><span class="w"> </span>./install_mace.sh
</code></pre></div>

<p>这在以下两种情况下特别有用：<br />
- 确保环境与您的 CUDA 驱动兼容<br />
- 在无 GPU 的节点上安装，但计划在 GPU 节点上运行（强制安装 CUDA 构建）</p>
<p>这将创建一个名为 <code>mlp-train-mace</code> 的 conda 环境。</p>
<h3 id="3">3. 激活环境<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p>根据您要使用的模型，激活相应的环境：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用 GAP</span>
conda<span class="w"> </span>activate<span class="w"> </span>mlp-train-gap

<span class="c1"># 使用 ACE</span>
conda<span class="w"> </span>activate<span class="w"> </span>mlp-train-ace

<span class="c1"># 使用 MACE</span>
conda<span class="w"> </span>activate<span class="w"> </span>mlp-train-mace
</code></pre></div>

<h2 id="_4">验证安装<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>安装完成后，可以通过以下方式验证：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</code></pre></div>

<p>如果能够成功导入并显示版本号，说明安装成功。</p>
<h2 id="openmm">安装 OpenMM 支持<a class="headerlink" href="#openmm" title="Permanent link">&para;</a></h2>
<p>OpenMM 后端目前仅与 MACE 配合工作。MACE 安装过程中会自动安装必要的依赖。</p>
<p>安装完成后，您可以运行 <code>examples/water_openmm.py</code> 来测试 OpenMM 功能。</p>
<h2 id="_5">依赖说明<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">核心依赖<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<ul>
<li><code>numpy</code></li>
<li><code>ase</code> (Atomic Simulation Environment)</li>
<li><code>autode</code></li>
<li><code>scipy</code></li>
</ul>
<h3 id="_7">模型特定依赖<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>GAP</strong>: <code>quippy</code> (QUIP 包)</li>
<li><strong>ACE</strong>: <code>julia</code> (&gt;= 1.6), <code>ACE1.jl</code></li>
<li><strong>MACE</strong>: <code>torch</code>, <code>mace-torch</code></li>
</ul>
<h3 id="_8">可选依赖<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>OpenMM</strong>: 用于 OpenMM 后端（仅 MACE）</li>
<li><strong>PLUMED</strong>: 用于高级采样方法</li>
</ul>
<h2 id="_9">常见问题<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<h3 id="1julia">问题 1：Julia 未找到<a class="headerlink" href="#1julia" title="Permanent link">&para;</a></h3>
<p><strong>症状</strong>：安装 ACE 时提示找不到 Julia</p>
<p><strong>解决方案</strong>：<br />
1. 确保已安装 Julia（版本 &gt;= 1.6）<br />
2. 确保 Julia 在系统 PATH 中：<br />
<code>bash
   which julia</code><br />
3. 如果未找到，将 Julia 添加到 PATH：<br />
<code>bash
   export PATH=$PATH:/path/to/julia/bin</code></p>
<h3 id="2cuda">问题 2：CUDA 相关错误<a class="headerlink" href="#2cuda" title="Permanent link">&para;</a></h3>
<p><strong>症状</strong>：MACE 安装时出现 CUDA 相关错误</p>
<p><strong>解决方案</strong>：<br />
1. 检查 CUDA 驱动版本：<br />
<code>bash
   nvidia-smi</code><br />
2. 使用 <code>CONDA_OVERRIDE_CUDA</code> 指定兼容的 CUDA 版本<br />
3. 如果不需要 GPU，可以安装 CPU 版本</p>
<h3 id="3_1">问题 3：权限错误<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<p><strong>症状</strong>：安装脚本无法执行</p>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code>chmod<span class="w"> </span>+x<span class="w"> </span>install_*.sh
</code></pre></div>

<h3 id="4conda">问题 4：conda 环境冲突<a class="headerlink" href="#4conda" title="Permanent link">&para;</a></h3>
<p><strong>症状</strong>：环境创建失败或依赖冲突</p>
<p><strong>解决方案</strong>：<br />
1. 确保使用最新的 conda<br />
2. 清理 conda 缓存：<br />
<code>bash
   conda clean --all</code><br />
3. 尝试使用 <code>--force</code> 选项重新创建环境</p>
<h2 id="_10">开发者安装<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<p>如果您想为项目贡献代码，需要安装开发依赖：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 在激活的环境中</span>
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;.[docs]&quot;</span>
pre-commit<span class="w"> </span>install
</code></pre></div>

<p>这将安装：<br />
- 开发模式下的包<br />
- 文档生成工具<br />
- 代码检查工具（pre-commit, Ruff）</p>
<h2 id="_11">下一步<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>安装完成后，请查看 <a href="03_快速开始.md">快速开始指南</a> 来开始使用 mlp-train。</p>
            </section>

            <section id="section-2" class="section">
                <h1 id="_1">快速开始<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>本指南将带您快速上手 mlp-train，通过一个简单的例子演示如何使用 mlp-train 训练机器学习势能并运行分子动力学模拟。</p>
<h2 id="_2">准备工作<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>激活环境</strong>：根据您要使用的模型，激活相应的 conda 环境<br />
<code>bash
   conda activate mlp-train-gap  # 或 mlp-train-ace, mlp-train-mace</code></p>
</li>
<li>
<p><strong>准备输入文件</strong>：创建一个包含分子结构的 XYZ 文件（例如 <code>water.xyz</code>）<br />
<code>3
   water
   O    0.0000    0.0000    0.0000
   H    0.7570    0.5860    0.0000
   H   -0.7570    0.5860    0.0000</code></p>
</li>
</ol>
<h2 id="gap">最简单的例子：训练 GAP 势能<a class="headerlink" href="#gap" title="Permanent link">&para;</a></h2>
<p>以下是一个完整的示例，展示如何训练一个简单的 GAP 势能：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 设置使用的核心数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># 设置量子化学方法（例如使用 ORCA）</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="s1">&#39;def2-SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;EnGrad&#39;</span><span class="p">]</span>

<span class="c1"># 创建系统（无周期性边界条件）</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># 初始化 GAP 势能</span>
<span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 使用主动学习训练，使用 ORCA 作为参考方法，温度 1000 K</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># 运行分子动力学模拟</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>          <span class="c1"># 模拟时间 200 fs</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>        <span class="c1"># 温度 300 K</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>          <span class="c1"># 时间步长 0.5 fs</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>     <span class="c1"># 每 10 步保存一次</span>
<span class="p">)</span>

<span class="c1"># 比较 MLP 预测与真实值</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">)</span>

<span class="c1"># 保存轨迹</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;water_trajectory.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="ace">使用 ACE 模型<a class="headerlink" href="#ace" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.training.selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomicEnvSimilarity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.descriptor</span><span class="w"> </span><span class="kn">import</span> <span class="n">SoapDescriptor</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># 创建系统</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># 初始化 ACE 势能</span>
<span class="n">ace</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">ACE</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 设置描述符和选择器</span>
<span class="n">descriptor</span> <span class="o">=</span> <span class="n">SoapDescriptor</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">r_cut</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">l_max</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">selector</span> <span class="o">=</span> <span class="n">AtomicEnvSimilarity</span><span class="p">(</span><span class="n">descriptor</span><span class="o">=</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.9995</span><span class="p">)</span>

<span class="c1"># 使用主动学习训练</span>
<span class="n">ace</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span> <span class="n">selection_method</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># 运行 MD 模拟</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">ace</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;water_trajectory.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="mace-openmm">使用 MACE 模型（OpenMM）<a class="headerlink" href="#mace-openmm" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># 创建系统</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># 初始化 MACE 势能</span>
<span class="n">mace</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">MACE</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 使用主动学习训练（使用 OpenMM）</span>
<span class="n">mace</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">max_active_iters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">max_active_time</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">md_program</span><span class="o">=</span><span class="s1">&#39;OpenMM&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 使用 OpenMM 运行 MD 模拟</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md_openmm</span><span class="o">.</span><span class="n">run_mlp_md_openmm</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">mace</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;water_trajectory.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_3">代码解释<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="1">1. 导入和配置<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>
</code></pre></div>

<ul>
<li>导入 mlptrain 模块</li>
<li>设置使用的 CPU 核心数</li>
</ul>
<h3 id="2">2. 创建系统<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><code>Molecule('water.xyz')</code>：从 XYZ 文件读取分子</li>
<li><code>System(..., box=None)</code>：创建无周期性边界条件的系统</li>
</ul>
<h3 id="3-mlp">3. 初始化 MLP<a class="headerlink" href="#3-mlp" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>
</code></pre></div>

<ul>
<li>创建名为 'water' 的 GAP 势能</li>
<li>该势能将保存为 <code>water_gap.xml</code></li>
</ul>
<h3 id="4">4. 主动学习训练<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</code></pre></div>

<ul>
<li><code>method_name</code>：参考方法（'orca', 'xtb', 'gaussian' 等）</li>
<li><code>temp</code>：主动学习时的温度（K）</li>
</ul>
<h3 id="5-md">5. 运行 MD 模拟<a class="headerlink" href="#5-md" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<ul>
<li><code>configuration</code>：起始构型</li>
<li><code>mlp</code>：训练好的势能</li>
<li><code>fs</code>：模拟时间（飞秒）</li>
<li><code>temp</code>：温度（K）</li>
<li><code>dt</code>：时间步长（fs）</li>
<li><code>interval</code>：保存间隔（步数）</li>
</ul>
<h2 id="_4">支持的参考方法<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>mlp-train 支持多种量子化学方法作为参考：</p>
<ul>
<li><strong>xTB</strong>：快速半经验方法（推荐用于快速测试）</li>
<li><strong>ORCA</strong>：需要安装 ORCA 并配置</li>
<li><strong>Gaussian</strong>：需要安装 Gaussian 并配置</li>
<li><strong>GPAW</strong>：基于 DFT 的方法</li>
</ul>
<h2 id="_5">下一步<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<ul>
<li>了解 <a href="04_核心概念.md">核心概念</a></li>
<li>深入学习 <a href="05_MLP训练.md">MLP 训练</a></li>
<li>查看 <a href="09_示例教程.md">示例教程</a></li>
</ul>
            </section>

            <section id="section-3" class="section">
                <h1 id="_1">核心概念<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>理解 mlp-train 的核心概念对于有效使用该包至关重要。本章节介绍主要的数据结构和类。</p>
<h2 id="_2">主要类<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="molecule">Molecule（分子）<a class="headerlink" href="#molecule" title="Permanent link">&para;</a></h3>
<p><code>Molecule</code> 类表示一个分子，可以从 XYZ 文件读取或直接创建。</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 从文件读取</span>
<span class="n">molecule</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">)</span>

<span class="c1"># 带电荷和自旋多重度</span>
<span class="n">molecule</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><strong>主要属性</strong>：<br />
- <code>atoms</code>：原子列表<br />
- <code>charge</code>：电荷<br />
- <code>mult</code>：自旋多重度</p>
<h3 id="system">System（系统）<a class="headerlink" href="#system" title="Permanent link">&para;</a></h3>
<p><code>System</code> 类表示一个完整的系统，包含分子和可能的周期性边界条件。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 无周期性边界条件（气相）</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># 有周期性边界条件（溶液相）</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Box</span><span class="p">([</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">])</span>  <span class="c1"># 20 Å × 20 Å × 20 Å 的盒子</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)</span>
</code></pre></div>

<p><strong>主要方法</strong>：<br />
- <code>random_configuration()</code>：生成随机构型<br />
- <code>configuration()</code>：生成特定构型</p>
<h3 id="configuration">Configuration（构型）<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<p><code>Configuration</code> 类表示系统在某一时刻的原子构型，包含位置、能量、力等信息。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 从系统生成随机构型</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">()</span>

<span class="c1"># 从 XYZ 文件读取</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">from_xyz</span><span class="p">(</span><span class="s1">&#39;structure.xyz&#39;</span><span class="p">)</span>

<span class="c1"># 手动创建</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span>
    <span class="n">atoms</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>  <span class="c1"># 原子列表</span>
    <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">box</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>主要属性</strong>：<br />
- <code>atoms</code>：原子列表<br />
- <code>energy</code>：能量（Energy 对象）<br />
- <code>forces</code>：力（Forces 对象）<br />
- <code>box</code>：周期性盒子（Box 对象）<br />
- <code>charge</code>：电荷<br />
- <code>mult</code>：自旋多重度</p>
<p><strong>主要方法</strong>：<br />
- <code>save_xyz(filename)</code>：保存为 XYZ 格式<br />
- <code>energy.true</code>：真实能量值<br />
- <code>energy.predicted</code>：MLP 预测的能量值</p>
<h3 id="configurationset">ConfigurationSet（构型集合）<a class="headerlink" href="#configurationset" title="Permanent link">&para;</a></h3>
<p><code>ConfigurationSet</code> 类用于管理多个构型，通常用于训练数据集。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建空集合</span>
<span class="n">config_set</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">ConfigurationSet</span><span class="p">()</span>

<span class="c1"># 添加构型</span>
<span class="n">config_set</span> <span class="o">+=</span> <span class="n">config1</span>
<span class="n">config_set</span> <span class="o">+=</span> <span class="n">config2</span>

<span class="c1"># 或使用列表</span>
<span class="n">config_set</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">ConfigurationSet</span><span class="p">([</span><span class="n">config1</span><span class="p">,</span> <span class="n">config2</span><span class="p">,</span> <span class="n">config3</span><span class="p">])</span>

<span class="c1"># 从文件加载</span>
<span class="n">config_set</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">ConfigurationSet</span><span class="o">.</span><span class="n">from_xyz</span><span class="p">(</span><span class="s1">&#39;trajectory.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<p><strong>主要方法</strong>：<br />
- <code>save_xyz(filename)</code>：保存所有构型<br />
- <code>remove_above_e(threshold)</code>：移除能量高于阈值的构型<br />
- <code>has_a_none_energy</code>：检查是否有未计算能量的构型</p>
<h3 id="trajectory">Trajectory（轨迹）<a class="headerlink" href="#trajectory" title="Permanent link">&para;</a></h3>
<p><code>Trajectory</code> 类表示分子动力学轨迹，是 <code>ConfigurationSet</code> 的子类，但包含时间信息。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 从 MD 模拟生成</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># 从文件加载</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Trajectory</span><span class="o">.</span><span class="n">from_xyz</span><span class="p">(</span><span class="s1">&#39;trajectory.xyz&#39;</span><span class="p">)</span>

<span class="c1"># 访问构型</span>
<span class="n">first_config</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">last_config</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># 迭代</span>
<span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">trajectory</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">true</span><span class="p">)</span>
</code></pre></div>

<p><strong>主要方法</strong>：<br />
- <code>save(filename)</code>：保存轨迹<br />
- <code>compare(mlp, method_name)</code>：比较 MLP 预测与真实值<br />
- <code>plot()</code>：绘制轨迹</p>
<h3 id="box">Box（盒子）<a class="headerlink" href="#box" title="Permanent link">&para;</a></h3>
<p><code>Box</code> 类表示周期性边界条件的盒子。</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 立方盒子</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Box</span><span class="p">([</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">])</span>

<span class="c1"># 非立方盒子</span>
<span class="n">box</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Box</span><span class="p">([</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">])</span>
</code></pre></div>

<h3 id="mlpotential">MLPotential（机器学习势能）<a class="headerlink" href="#mlpotential" title="Permanent link">&para;</a></h3>
<p><code>MLPotential</code> 是所有 MLP 模型的基类。具体实现包括：</p>
<ul>
<li><code>mlt.potentials.GAP</code></li>
<li><code>mlt.potentials.ACE</code></li>
<li><code>mlt.potentials.MACE</code></li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 创建 GAP 势能</span>
<span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 创建 ACE 势能</span>
<span class="n">ace</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">ACE</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 创建 MACE 势能</span>
<span class="n">mace</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">MACE</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>
</code></pre></div>

<p><strong>主要属性</strong>：<br />
- <code>name</code>：势能名称<br />
- <code>system</code>：关联的系统<br />
- <code>training_data</code>：训练数据集（ConfigurationSet）</p>
<p><strong>主要方法</strong>：<br />
- <code>al_train(...)</code>：主动学习训练<br />
- <code>train(configurations)</code>：使用给定数据集训练<br />
- <code>predict(configuration)</code>：预测能量和力<br />
- <code>save()</code>：保存训练好的势能<br />
- <code>load()</code>：加载已保存的势能</p>
<h2 id="_3">能量和力<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="energy">Energy（能量）<a class="headerlink" href="#energy" title="Permanent link">&para;</a></h3>
<p><code>Energy</code> 类存储构型的能量信息。</p>
<div class="highlight"><pre><span></span><code><span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">true</span>        <span class="c1"># 真实能量（从量子化学计算）</span>
<span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">predicted</span>   <span class="c1"># MLP 预测的能量</span>
<span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">delta</span>       <span class="c1"># 误差（predicted - true）</span>
</code></pre></div>

<h3 id="forces">Forces（力）<a class="headerlink" href="#forces" title="Permanent link">&para;</a></h3>
<p><code>Forces</code> 类存储构型的力信息。</p>
<div class="highlight"><pre><span></span><code><span class="n">config</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">true</span>        <span class="c1"># 真实力（从量子化学计算）</span>
<span class="n">config</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">predicted</span>   <span class="c1"># MLP 预测的力</span>
<span class="n">config</span><span class="o">.</span><span class="n">forces</span><span class="o">.</span><span class="n">delta</span>       <span class="c1"># 误差</span>
</code></pre></div>

<h2 id="_4">数据流<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<p>典型的 mlp-train 工作流如下：</p>
<div class="highlight"><pre><span></span><code>Molecule → System → Configuration → ConfigurationSet → MLPotential
                                                              ↓
                                                         Trajectory
</code></pre></div>

<ol>
<li><strong>Molecule</strong>：定义分子结构</li>
<li><strong>System</strong>：定义完整系统（可能包含溶剂）</li>
<li><strong>Configuration</strong>：系统在某一时刻的构型</li>
<li><strong>ConfigurationSet</strong>：多个构型的集合（训练数据）</li>
<li><strong>MLPotential</strong>：训练好的机器学习势能</li>
<li><strong>Trajectory</strong>：MD 模拟生成的轨迹</li>
</ol>
<h2 id="_5">示例：完整工作流<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 1. 创建分子和系统</span>
<span class="n">molecule</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">)</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># 2. 创建 MLP</span>
<span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 3. 主动学习训练（内部生成 ConfigurationSet）</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># 4. 生成起始构型</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">()</span>

<span class="c1"># 5. 运行 MD 模拟生成轨迹</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 6. 分析轨迹</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">)</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;water_trajectory.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_6">下一步<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<ul>
<li>学习 <a href="05_MLP训练.md">MLP 训练</a> 的详细内容</li>
<li>了解 <a href="06_分子动力学.md">分子动力学模拟</a> 的使用方法</li>
</ul>
            </section>

            <section id="section-4" class="section">
                <h1 id="mlp">MLP 训练<a class="headerlink" href="#mlp" title="Permanent link">&para;</a></h1>
<p>mlp-train 的核心功能是使用主动学习（Active Learning）方法训练机器学习势能。本章节详细介绍训练过程和各种选项。</p>
<h2 id="_1">主动学习概述<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>主动学习是一个迭代过程，通过以下循环自动生成训练数据：</p>
<div class="highlight"><pre><span></span><code>生成构型 → 训练 MLP → 运行 MLP-MD → 选择构型 → 计算真实值 → 添加到训练集
     ↑                                                                      |
     |______________________________________________________________________|
</code></pre></div>

<h3 id="_2">主动学习的优势<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>自动化</strong>：无需手动准备训练数据</li>
<li><strong>高效</strong>：只计算对训练有用的构型</li>
<li><strong>自适应</strong>：自动探索构型空间</li>
</ul>
<h2 id="_3">基本训练<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<p>最简单的训练方式：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># 创建 MLP</span>
<span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 主动学习训练</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</code></pre></div>

<h3 id="_4">参数说明<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<ul>
<li><code>method_name</code>：参考方法（'orca', 'xtb', 'gaussian', 'gpaw' 等）</li>
<li><code>temp</code>：主动学习时的温度（K），较高温度有助于探索更多构型空间</li>
</ul>
<h2 id="_5">训练参数详解<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">基本参数<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>                    <span class="c1"># 温度（K）</span>
    <span class="n">max_active_iters</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>          <span class="c1"># 最大迭代次数</span>
    <span class="n">max_active_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>         <span class="c1"># 每次迭代最大时间（fs）</span>
    <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>           <span class="c1"># 每次迭代生成的构型数</span>
    <span class="n">n_init_configs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>            <span class="c1"># 初始构型数</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="selection-method">选择方法（Selection Method）<a class="headerlink" href="#selection-method" title="Permanent link">&para;</a></h3>
<p>选择方法决定哪些构型应该被添加到训练集。</p>
<h4 id="1-absdiffe">1. AbsDiffE（默认）<a class="headerlink" href="#1-absdiffe" title="Permanent link">&para;</a></h4>
<p>基于能量绝对误差的选择方法：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.training.selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbsDiffE</span>

<span class="n">selector</span> <span class="o">=</span> <span class="n">AbsDiffE</span><span class="p">(</span><span class="n">e_thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># 能量阈值（eV）</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">selection_method</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</code></pre></div>

<p><strong>工作原理</strong>：<br />
- 如果 <code>E_T &lt; |E_predicted - E_true| &lt; 10*E_T</code>，则选择该构型<br />
- 如果 <code>|E_predicted - E_true| &gt; 10*E_T</code>，则回溯并重新搜索</p>
<h4 id="2-atomicenvsimilarity">2. AtomicEnvSimilarity<a class="headerlink" href="#2-atomicenvsimilarity" title="Permanent link">&para;</a></h4>
<p>基于原子环境相似性的选择方法：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.training.selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomicEnvSimilarity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.descriptor</span><span class="w"> </span><span class="kn">import</span> <span class="n">SoapDescriptor</span>

<span class="c1"># 定义 SOAP 描述符</span>
<span class="n">descriptor</span> <span class="o">=</span> <span class="n">SoapDescriptor</span><span class="p">(</span>
    <span class="n">average</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span>
    <span class="n">r_cut</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span>      <span class="c1"># 截断半径（Å）</span>
    <span class="n">n_max</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>        <span class="c1"># 径向基函数数</span>
    <span class="n">l_max</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>        <span class="c1"># 角动量量子数</span>
<span class="p">)</span>

<span class="c1"># 创建选择器</span>
<span class="n">selector</span> <span class="o">=</span> <span class="n">AtomicEnvSimilarity</span><span class="p">(</span>
    <span class="n">descriptor</span><span class="o">=</span><span class="n">descriptor</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mf">0.9995</span>  <span class="c1"># 相似性阈值</span>
<span class="p">)</span>

<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span> <span class="n">selection_method</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</code></pre></div>

<p><strong>工作原理</strong>：<br />
- 计算新构型与训练集中所有构型的 SOAP 核相似性<br />
- 如果最大相似性在阈值范围内，则选择该构型</p>
<h4 id="3-atomicenvdistance">3. AtomicEnvDistance<a class="headerlink" href="#3-atomicenvdistance" title="Permanent link">&para;</a></h4>
<p>基于局部异常因子（LOF）的选择方法：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.training.selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomicEnvDistance</span>

<span class="n">selector</span> <span class="o">=</span> <span class="n">AtomicEnvDistance</span><span class="p">(</span>
    <span class="n">descriptor</span><span class="o">=</span><span class="n">descriptor</span><span class="p">,</span>
    <span class="n">pca</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>              <span class="c1"># 是否使用 PCA 降维</span>
    <span class="n">distance_metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span>  <span class="c1"># 距离度量</span>
    <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>         <span class="c1"># 邻居数</span>
<span class="p">)</span>

<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">selection_method</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</code></pre></div>

<h3 id="_7">能量阈值<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<p>限制添加到训练集的构型能量：</p>
<div class="highlight"><pre><span></span><code><span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">max_e_threshold</span><span class="o">=</span><span class="mf">5.0</span>  <span class="c1"># 最大相对能量（eV），高于此值的构型将被移除</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_8">初始构型<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<h4 id="_9">使用随机初始构型<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">n_init_configs</span><span class="o">=</span><span class="mi">20</span>  <span class="c1"># 生成 20 个随机初始构型</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="_10">使用预定义初始构型<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 准备初始构型集</span>
<span class="n">init_configs</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">ConfigurationSet</span><span class="p">()</span>
<span class="n">init_configs</span> <span class="o">+=</span> <span class="n">config1</span>
<span class="n">init_configs</span> <span class="o">+=</span> <span class="n">config2</span>

<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">init_configs</span><span class="o">=</span><span class="n">init_configs</span>  <span class="c1"># 使用预定义的初始构型</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="_11">固定初始构型<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">fix_init_config</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 每次迭代都从同一个初始构型开始</span>
<span class="p">)</span>
</code></pre></div>

<p>默认情况下，每次迭代会选择能量最低的构型作为起始点。</p>
<h3 id="_12">约束和偏置<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h3>
<h4 id="_13">添加约束<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">ase.constraints</span><span class="w"> </span><span class="kn">import</span> <span class="n">FixBondLength</span>

<span class="c1"># 固定键长</span>
<span class="n">constraint</span> <span class="o">=</span> <span class="n">FixBondLength</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 固定原子 0 和 1 之间的键长</span>

<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">constraint</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="_14">添加偏置势<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bias</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.reaction_coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">AverageDistance</span>

<span class="c1"># 定义反应坐标</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">AverageDistance</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># 创建偏置</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">Bias</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>  <span class="c1"># 弹簧常数 0.1 eV/Å²，参考值 2.0 Å</span>

<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
    <span class="n">bias_start_iter</span><span class="o">=</span><span class="mi">5</span>  <span class="c1"># 从第 5 次迭代开始应用偏置</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_15">键断裂/形成能量<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>在特定键方向添加额外能量，促进反应：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 键断裂能量</span>
<span class="n">bbond_energy</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># 在原子 0 和 1 之间添加 0.1 eV 的断裂能量</span>

<span class="c1"># 键形成能量</span>
<span class="n">fbond_energy</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># 在原子 2 和 3 之间添加 0.1 eV 的形成能量</span>

<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">bbond_energy</span><span class="o">=</span><span class="n">bbond_energy</span><span class="p">,</span>
    <span class="n">fbond_energy</span><span class="o">=</span><span class="n">fbond_energy</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="openmm">使用 OpenMM<a class="headerlink" href="#openmm" title="Permanent link">&para;</a></h3>
<p>MACE 模型支持使用 OpenMM 进行 MD 模拟：</p>
<div class="highlight"><pre><span></span><code><span class="n">mace</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">MACE</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="n">mace</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">md_program</span><span class="o">=</span><span class="s1">&#39;OpenMM&#39;</span><span class="p">,</span>  <span class="c1"># 使用 OpenMM 而不是 ASE</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_16">周期性边界条件<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p>对于溶液相系统：</p>
<div class="highlight"><pre><span></span><code><span class="n">box</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Box</span><span class="p">([</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">])</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)</span>

<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">pbc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>              <span class="c1"># 启用周期性边界条件</span>
    <span class="n">box_size</span><span class="o">=</span><span class="p">[</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_17">训练过程监控<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h2>
<p>训练过程中会输出以下信息：</p>
<ul>
<li>当前迭代次数</li>
<li>已添加的构型数</li>
<li>训练数据集大小</li>
<li>能量误差统计</li>
</ul>
<h2 id="_18">训练结果<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h2>
<p>训练完成后：</p>
<ul>
<li><strong>训练数据</strong>：保存在 <code>mlp.training_data</code> 中</li>
<li><strong>模型文件</strong>：根据模型类型保存（如 <code>water_gap.xml</code>）</li>
<li><strong>日志信息</strong>：显示在控制台</li>
</ul>
<h3 id="_19">访问训练数据<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 训练数据集大小</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;训练数据点数: </span><span class="si">{</span><span class="n">gap</span><span class="o">.</span><span class="n">n_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 访问训练数据</span>
<span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">gap</span><span class="o">.</span><span class="n">training_data</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;能量: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">true</span><span class="si">}</span><span class="s2"> eV&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_20">保存和加载<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 保存（通常在训练时自动保存）</span>
<span class="n">gap</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># 加载已训练的模型</span>
<span class="n">gap</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>

<h2 id="_21">高级选项<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h2>
<h3 id="_22">重启训练<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p>从特定迭代重新开始：</p>
<div class="highlight"><pre><span></span><code><span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">restart_iter</span><span class="o">=</span><span class="mi">10</span>  <span class="c1"># 从第 10 次迭代重新开始</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_23">继承元动力学偏置<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>在主动学习中继承之前的元动力学偏置：</p>
<div class="highlight"><pre><span></span><code><span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">inherit_metad_bias</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 继承元动力学偏置</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="al">保存 AL 轨迹<a class="headerlink" href="#al" title="Permanent link">&para;</a></h3>
<p>保存主动学习过程中生成的轨迹：</p>
<div class="highlight"><pre><span></span><code><span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">keep_al_trajs</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 保存 AL 轨迹到单独文件夹</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_24">最佳实践<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h2>
<ol>
<li><strong>选择合适的温度</strong>：</li>
<li>较低温度（300-500 K）：适合稳定结构</li>
<li>
<p>较高温度（1000-2000 K）：适合探索反应路径</p>
</li>
<li>
<p><strong>调整选择方法</strong>：</p>
</li>
<li>简单系统：使用 <code>AbsDiffE</code></li>
<li>
<p>复杂系统：使用 <code>AtomicEnvSimilarity</code></p>
</li>
<li>
<p><strong>监控训练过程</strong>：</p>
</li>
<li>观察添加的构型数</li>
<li>
<p>检查能量误差是否收敛</p>
</li>
<li>
<p><strong>验证训练结果</strong>：</p>
</li>
<li>使用 <code>trajectory.compare()</code> 比较预测与真实值</li>
<li>检查能量和力的误差分布</li>
</ol>
<h2 id="_25">下一步<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h2>
<ul>
<li>学习如何运行 <a href="06_分子动力学.md">分子动力学模拟</a></li>
<li>了解 <a href="07_高级采样.md">高级采样方法</a></li>
</ul>
            </section>

            <section id="section-5" class="section">
                <h1 id="_1">分子动力学模拟<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>mlp-train 支持使用训练好的机器学习势能运行分子动力学（MD）模拟。本章节介绍如何使用 ASE 和 OpenMM 两种引擎进行 MD 模拟。</p>
<h2 id="md">基本 MD 模拟<a class="headerlink" href="#md" title="Permanent link">&para;</a></h2>
<h3 id="ase">使用 ASE（默认）<a class="headerlink" href="#ase" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 准备系统</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 训练（或加载已训练的模型）</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># 运行 MD 模拟</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>          <span class="c1"># 模拟时间 200 fs</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>        <span class="c1"># 温度 300 K</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>          <span class="c1"># 时间步长 0.5 fs</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>     <span class="c1"># 每 10 步保存一次</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="openmm-mace">使用 OpenMM（仅 MACE）<a class="headerlink" href="#openmm-mace" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">mace</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">MACE</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 训练</span>
<span class="n">mace</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">md_program</span><span class="o">=</span><span class="s1">&#39;OpenMM&#39;</span><span class="p">)</span>

<span class="c1"># 使用 OpenMM 运行 MD</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md_openmm</span><span class="o">.</span><span class="n">run_mlp_md_openmm</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">mace</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>         <span class="c1"># 模拟时间 2000 fs</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>        <span class="c1"># 温度 300 K</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>          <span class="c1"># 时间步长 0.5 fs</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>    <span class="c1"># 每 100 步保存一次</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_2">参数详解<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">基本参数<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<ul>
<li><code>configuration</code>：起始构型</li>
<li><code>mlp</code>：训练好的机器学习势能</li>
<li><code>temp</code>：温度（K），设为 0 则运行 NVE 模拟</li>
<li><code>dt</code>：时间步长（fs）</li>
<li><code>interval</code>：保存间隔（步数）</li>
</ul>
<h3 id="_4">时间参数<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>可以使用不同的时间单位：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用 fs（飞秒）</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="c1"># 使用 ps（皮秒）</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 使用 ns（纳秒）</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div>

<h3 id="_5">保存间隔<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用步数</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 使用时间单位</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">save_fs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>   <span class="c1"># 每 5 fs 保存一次</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">save_ps</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span> <span class="c1"># 每 0.1 ps 保存一次</span>
</code></pre></div>

<h3 id="_6">初始温度<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>设置初始温度（用于初始化速度）：</p>
<div class="highlight"><pre><span></span><code><span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>        <span class="c1"># 运行温度</span>
    <span class="n">init_temp</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>  <span class="c1"># 初始温度（用于初始化速度）</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="npt">NPT 系综（等温等压）<a class="headerlink" href="#npt" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">pressure</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>      <span class="c1"># 压力（bar）</span>
    <span class="n">compress</span><span class="o">=</span><span class="mf">4.57e-5</span><span class="p">,</span>  <span class="c1"># 压缩率（bar⁻¹），水的典型值</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>注意</strong>：NPT 模拟目前仅在生产运行中实现，不在主动学习中使用。</p>
<h2 id="_7">约束<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="ase_1">ASE 约束<a class="headerlink" href="#ase_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">ase.constraints</span><span class="w"> </span><span class="kn">import</span> <span class="n">FixBondLength</span><span class="p">,</span> <span class="n">FixAngle</span>

<span class="c1"># 固定键长</span>
<span class="n">constraint1</span> <span class="o">=</span> <span class="n">FixBondLength</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># 固定原子 0 和 1 之间的键长</span>

<span class="c1"># 固定角度</span>
<span class="n">constraint2</span> <span class="o">=</span> <span class="n">FixAngle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># 固定原子 0-1-2 的角度</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">constraint1</span><span class="p">,</span> <span class="n">constraint2</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_8">偏置势<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="_9">简单偏置<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bias</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.reaction_coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">AverageDistance</span>

<span class="c1"># 定义反应坐标（平均距离）</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">AverageDistance</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># 创建偏置（简谐势）</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">Bias</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>  <span class="c1"># 弹簧常数 0.1 eV/Å²，参考值 2.0 Å</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">bias</span><span class="o">=</span><span class="n">bias</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="plumed">PLUMED 偏置<a class="headerlink" href="#plumed" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedBias</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedAverageCV</span>

<span class="c1"># 定义 PLUMED 集体变量</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">PlumedAverageCV</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># 创建 PLUMED 偏置</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">PlumedBias</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">])</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">bias</span><span class="o">=</span><span class="n">bias</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_10">键断裂/形成能量<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<p>在特定键方向添加额外能量：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 键断裂能量</span>
<span class="n">bbond_energy</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># 在原子 0 和 1 之间添加 0.1 eV</span>

<span class="c1"># 键形成能量</span>
<span class="n">fbond_energy</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span> <span class="mf">0.1</span><span class="p">}</span>  <span class="c1"># 在原子 2 和 3 之间添加 0.1 eV</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">bbond_energy</span><span class="o">=</span><span class="n">bbond_energy</span><span class="p">,</span>
    <span class="n">fbond_energy</span><span class="o">=</span><span class="n">fbond_energy</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_11">重启模拟<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>从之前的轨迹继续模拟：</p>
<div class="highlight"><pre><span></span><code><span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">restart_files</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;trajectory.traj&#39;</span><span class="p">,</span> <span class="s1">&#39;simulation.state.xml&#39;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_12">轨迹分析<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<h3 id="_13">保存轨迹<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 保存为 XYZ 格式</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;water_trajectory.xyz&#39;</span><span class="p">)</span>

<span class="c1"># 保存为其他格式（如果支持）</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">save_xyz</span><span class="p">(</span><span class="s1">&#39;water_trajectory.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_14">比较预测与真实值<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 计算真实能量和力（使用参考方法）</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span> <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">)</span>
</code></pre></div>

<p>这会生成：<br />
- 能量对比图<br />
- 力对比图<br />
- 误差统计</p>
<h3 id="_15">访问轨迹数据<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 访问特定构型</span>
<span class="n">first_config</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">last_config</span> <span class="o">=</span> <span class="n">trajectory</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># 迭代所有构型</span>
<span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">trajectory</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;时间: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">time</span><span class="si">}</span><span class="s2"> fs&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;能量: </span><span class="si">{</span><span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">predicted</span><span class="si">}</span><span class="s2"> eV&quot;</span><span class="p">)</span>

<span class="c1"># 获取所有能量</span>
<span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">predicted</span> <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">trajectory</span><span class="p">]</span>
</code></pre></div>

<h3 id="_16">绘制轨迹<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 绘制能量随时间的变化</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div>

<h2 id="openmm">OpenMM 特定选项<a class="headerlink" href="#openmm" title="Permanent link">&para;</a></h2>
<h3 id="_17">选择平台<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md_openmm</span><span class="o">.</span><span class="n">run_mlp_md_openmm</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CUDA&#39;</span>  <span class="c1"># &#39;CUDA&#39;, &#39;OpenCL&#39;, &#39;CPU&#39;, &#39;Reference&#39;</span>
<span class="p">)</span>
</code></pre></div>

<p>如果不指定，会自动选择最快的可用平台（按顺序：CUDA &gt; OpenCL &gt; CPU &gt; Reference）。</p>
<h3 id="plumed_1">保存 PLUMED 设置<a class="headerlink" href="#plumed_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md_openmm</span><span class="o">.</span><span class="n">run_mlp_md_openmm</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">write_plumed_setup</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 保存 PLUMED 输入文件为 plumed_setup.dat</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_18">周期性边界条件<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h2>
<p>对于溶液相系统：</p>
<div class="highlight"><pre><span></span><code><span class="n">box</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Box</span><span class="p">([</span><span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">])</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)</span>

<span class="c1"># 确保构型有盒子信息</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">box</span>

<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_19">性能优化<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h2>
<h3 id="_20">并行计算<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 设置使用的核心数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># MD 模拟会自动使用配置的核心数</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>

<h3 id="_21">时间步长选择<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>小分子</strong>：0.5 fs</li>
<li><strong>中等分子</strong>：1.0 fs</li>
<li><strong>大分子</strong>：2.0 fs（需谨慎）</li>
</ul>
<h3 id="_22">保存频率<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>短时间模拟</strong>：每 10-50 步保存一次</li>
<li><strong>长时间模拟</strong>：每 100-1000 步保存一次</li>
</ul>
<h2 id="_23">常见问题<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h2>
<h3 id="1">问题 1：能量不守恒<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p><strong>可能原因</strong>：<br />
- 时间步长太大<br />
- MLP 预测不准确</p>
<p><strong>解决方案</strong>：<br />
- 减小时间步长<br />
- 重新训练 MLP，增加训练数据</p>
<h3 id="2">问题 2：模拟崩溃<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p><strong>可能原因</strong>：<br />
- 起始构型不合理<br />
- 温度过高<br />
- MLP 在未训练区域预测</p>
<p><strong>解决方案</strong>：<br />
- 使用能量最小化后的构型<br />
- 降低温度<br />
- 增加训练数据覆盖范围</p>
<h3 id="3openmm-gpu">问题 3：OpenMM 无法找到 GPU<a class="headerlink" href="#3openmm-gpu" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 明确指定使用 CPU</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md_openmm</span><span class="o">.</span><span class="n">run_mlp_md_openmm</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CPU&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_24">下一步<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h2>
<ul>
<li>学习 <a href="07_高级采样.md">高级采样方法</a></li>
<li>查看 <a href="09_示例教程.md">示例教程</a></li>
</ul>
            </section>

            <section id="section-6" class="section">
                <h1 id="_1">高级采样方法<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>mlp-train 提供了多种高级采样方法，用于探索构型空间和计算自由能。本章节介绍元动力学和伞形采样。</p>
<h2 id="metadynamics">元动力学（Metadynamics）<a class="headerlink" href="#metadynamics" title="Permanent link">&para;</a></h2>
<p>元动力学是一种增强采样技术，通过在集体变量（CV）空间添加偏置势来促进构型空间探索。</p>
<h3 id="_2">基本使用<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedAverageCV</span>

<span class="c1"># 定义集体变量（例如：两个原子间的平均距离）</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">PlumedAverageCV</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># 创建元动力学对象</span>
<span class="n">metad</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Metadynamics</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span> <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># 运行元动力学模拟</span>
<span class="n">metad</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>      <span class="c1"># 模拟时间</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_3">定义集体变量<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<h4 id="_4">平均距离<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedAverageCV</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">PlumedAverageCV</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># 原子 0 和 1 之间的平均距离</span>
</code></pre></div>

<h4 id="_5">距离差<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedDifferenceCV</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">PlumedDifferenceCV</span><span class="p">(</span>
    <span class="n">atom_idxs1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># 第一组原子</span>
    <span class="n">atom_idxs2</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>   <span class="c1"># 第二组原子</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="_6">配位数<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedCNCV</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">PlumedCNCV</span><span class="p">(</span>
    <span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>      <span class="c1"># 中心原子</span>
    <span class="n">r_0</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span>            <span class="c1"># 参考距离（Å）</span>
    <span class="n">n</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>                <span class="c1"># 配位数</span>
    <span class="n">m</span><span class="o">=</span><span class="mi">12</span>                <span class="c1"># 平滑参数</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="cv">自定义 CV<a class="headerlink" href="#cv" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedCustomCV</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">PlumedCustomCV</span><span class="p">(</span>
    <span class="n">plumed_cv_string</span><span class="o">=</span><span class="s2">&quot;DISTANCE ATOMS=1,2&quot;</span>  <span class="c1"># PLUMED 格式的 CV 定义</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="cv_1">多 CV 元动力学<a class="headerlink" href="#cv_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">cv1</span> <span class="o">=</span> <span class="n">PlumedAverageCV</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">cv2</span> <span class="o">=</span> <span class="n">PlumedAverageCV</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="n">metad</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Metadynamics</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv1</span><span class="p">,</span> <span class="n">cv2</span><span class="p">],</span> <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</code></pre></div>

<h3 id="_7">调整元动力学参数<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">metad</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Metadynamics</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span> <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># 估计高斯宽度（自动）</span>
<span class="n">metad</span><span class="o">.</span><span class="n">estimate_width</span><span class="p">(</span><span class="n">configurations</span><span class="o">=</span><span class="n">config_set</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">)</span>

<span class="c1"># 手动设置参数</span>
<span class="n">metad</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mf">0.1</span>      <span class="c1"># 高斯高度（eV）</span>
<span class="n">metad</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.1</span>       <span class="c1"># 高斯宽度（CV 单位）</span>
<span class="n">metad</span><span class="o">.</span><span class="n">pace</span> <span class="o">=</span> <span class="mi">100</span>        <span class="c1"># 添加高斯的频率（步数）</span>
</code></pre></div>

<h3 id="well-tempered-metadynamics">良好调温元动力学（Well-Tempered Metadynamics）<a class="headerlink" href="#well-tempered-metadynamics" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">metad</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Metadynamics</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span> <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># 设置调温参数</span>
<span class="n">metad</span><span class="o">.</span><span class="n">bias_factor</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># 偏置因子（越大，偏置增长越慢）</span>

<span class="c1"># 运行良好调温元动力学</span>
<span class="n">metad</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>

<h3 id="_8">分析元动力学结果<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<h4 id="cv_2">绘制 CV 随时间变化<a class="headerlink" href="#cv_2" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_cv_versus_time</span>

<span class="n">plot_cv_versus_time</span><span class="p">(</span><span class="s1">&#39;COLVAR&#39;</span><span class="p">)</span>  <span class="c1"># COLVAR 是 PLUMED 输出文件</span>
</code></pre></div>

<h4 id="2d">绘制 2D 自由能面<a class="headerlink" href="#2d" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_cv1_and_cv2</span>

<span class="n">plot_cv1_and_cv2</span><span class="p">(</span><span class="s1">&#39;COLVAR&#39;</span><span class="p">,</span> <span class="n">cv1_name</span><span class="o">=</span><span class="s1">&#39;cv1&#39;</span><span class="p">,</span> <span class="n">cv2_name</span><span class="o">=</span><span class="s1">&#39;cv2&#39;</span><span class="p">)</span>
</code></pre></div>

<h4 id="_9">计算自由能<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="c1"># 从元动力学轨迹计算自由能</span>
<span class="n">free_energy</span> <span class="o">=</span> <span class="n">metad</span><span class="o">.</span><span class="n">compute_free_energy</span><span class="p">(</span>
    <span class="n">trajectory</span><span class="o">=</span><span class="n">trajectory</span><span class="p">,</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="umbrella-sampling">伞形采样（Umbrella Sampling）<a class="headerlink" href="#umbrella-sampling" title="Permanent link">&para;</a></h2>
<p>伞形采样通过在反应坐标的不同位置放置简谐偏置来系统地采样构型空间。</p>
<h3 id="_10">基本使用<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.reaction_coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">AverageDistance</span>

<span class="c1"># 定义反应坐标</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">AverageDistance</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># 创建伞形采样对象</span>
<span class="n">umbrella</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">UmbrellaSampling</span><span class="p">(</span>
    <span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span>
<span class="p">)</span>

<span class="c1"># 定义窗口（沿反应坐标的位置）</span>
<span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">]</span>  <span class="c1"># 距离值（Å）</span>

<span class="c1"># 运行伞形采样</span>
<span class="n">umbrella</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">configurations</span><span class="o">=</span><span class="p">[</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">()]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">windows</span><span class="o">=</span><span class="n">windows</span><span class="p">,</span>
    <span class="n">kappas</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">),</span>  <span class="c1"># 弹簧常数（eV/Å²）</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>                      <span class="c1"># 每个窗口的模拟时间</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_11">定义反应坐标<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<h4 id="_12">平均距离<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.reaction_coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">AverageDistance</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">AverageDistance</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</code></pre></div>

<h4 id="_13">距离差<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.reaction_coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">DifferenceDistance</span>

<span class="n">cv</span> <span class="o">=</span> <span class="n">DifferenceDistance</span><span class="p">(</span>
    <span class="n">atom_idxs1</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">atom_idxs2</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_14">调整窗口参数<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 不同窗口使用不同的弹簧常数</span>
<span class="n">kappas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">]</span>  <span class="c1"># 窗口边缘使用更大的弹簧常数</span>

<span class="n">umbrella</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">windows</span><span class="o">=</span><span class="n">windows</span><span class="p">,</span>
    <span class="n">kappas</span><span class="o">=</span><span class="n">kappas</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="wham">使用 WHAM 分析<a class="headerlink" href="#wham" title="Permanent link">&para;</a></h3>
<p>加权直方图分析方法（WHAM）用于从伞形采样数据计算自由能：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 运行伞形采样后</span>
<span class="n">umbrella</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># 使用 WHAM 计算自由能</span>
<span class="n">free_energy</span> <span class="o">=</span> <span class="n">umbrella</span><span class="o">.</span><span class="n">compute_free_energy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;wham&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="ui">使用 UI 分析<a class="headerlink" href="#ui" title="Permanent link">&para;</a></h3>
<p>非平衡积分方法（UI）是另一种分析伞形采样数据的方法：</p>
<div class="highlight"><pre><span></span><code><span class="n">free_energy</span> <span class="o">=</span> <span class="n">umbrella</span><span class="o">.</span><span class="n">compute_free_energy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ui&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="_15">绘制自由能曲线<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 计算自由能后</span>
<span class="n">free_energy</span> <span class="o">=</span> <span class="n">umbrella</span><span class="o">.</span><span class="n">compute_free_energy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;wham&#39;</span><span class="p">)</span>

<span class="c1"># 绘制</span>
<span class="n">umbrella</span><span class="o">.</span><span class="n">plot_free_energy</span><span class="p">()</span>
</code></pre></div>

<h2 id="_16">在主动学习中使用高级采样<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h2>
<h3 id="_17">元动力学辅助的主动学习<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedBias</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.plumed</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlumedAverageCV</span>

<span class="c1"># 定义 CV</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">PlumedAverageCV</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># 创建 PLUMED 偏置</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">PlumedBias</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">])</span>

<span class="c1"># 在主动学习中使用</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
    <span class="n">inherit_metad_bias</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># 继承元动力学偏置</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="_18">伞形采样辅助的主动学习<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling</span><span class="w"> </span><span class="kn">import</span> <span class="n">Bias</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.reaction_coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">AverageDistance</span>

<span class="c1"># 定义反应坐标</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">AverageDistance</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># 创建偏置</span>
<span class="n">bias</span> <span class="o">=</span> <span class="n">Bias</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>

<span class="c1"># 在主动学习中使用</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">,</span>
    <span class="n">bias_start_iter</span><span class="o">=</span><span class="mi">5</span>  <span class="c1"># 从第 5 次迭代开始应用偏置</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_19">组合使用<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h2>
<h3 id="_20">元动力学 + 伞形采样<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>可以先用元动力学探索构型空间，然后用伞形采样精确计算自由能：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 元动力学探索</span>
<span class="n">metad</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Metadynamics</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span> <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">metad</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># 2. 从元动力学轨迹确定窗口位置</span>
<span class="c1"># （手动分析或自动检测）</span>

<span class="c1"># 3. 伞形采样精确计算</span>
<span class="n">umbrella</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">UmbrellaSampling</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span> <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">umbrella</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</code></pre></div>

<h2 id="_21">最佳实践<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h2>
<h3 id="_22">元动力学<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>选择合适的 CV</strong>：</li>
<li>CV 应该能够区分不同的状态</li>
<li>
<p>避免使用快变量作为 CV</p>
</li>
<li>
<p><strong>调整参数</strong>：</p>
</li>
<li>使用 <code>estimate_width()</code> 自动估计高斯宽度</li>
<li>
<p>对于良好调温元动力学，选择合适的偏置因子</p>
</li>
<li>
<p><strong>监控模拟</strong>：</p>
</li>
<li>检查 CV 是否充分采样</li>
<li>确保偏置不会过度增长</li>
</ol>
<h3 id="_23">伞形采样<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>窗口间距</strong>：</li>
<li>窗口之间应该有足够的重叠</li>
<li>
<p>通常间距为 0.2-0.5 Å（对于距离 CV）</p>
</li>
<li>
<p><strong>弹簧常数</strong>：</p>
</li>
<li>足够大以限制采样范围</li>
<li>
<p>但不要太大，以免限制构型探索</p>
</li>
<li>
<p><strong>模拟时间</strong>：</p>
</li>
<li>每个窗口至少需要几千步</li>
<li>确保在每个窗口内充分采样</li>
</ol>
<h2 id="_24">常见问题<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h2>
<h3 id="1">问题 1：元动力学偏置增长过快<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：<br />
- 使用良好调温元动力学<br />
- 增加偏置因子<br />
- 减小高斯高度</p>
<h3 id="2">问题 2：伞形采样窗口重叠不足<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：<br />
- 减小窗口间距<br />
- 增加弹簧常数<br />
- 增加模拟时间</p>
<h3 id="3">问题 3：自由能计算不收敛<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：<br />
- 增加每个窗口的模拟时间<br />
- 检查窗口是否有足够的重叠<br />
- 尝试不同的分析方法（WHAM vs UI）</p>
<h2 id="_25">下一步<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h2>
<ul>
<li>查看 <a href="08_配置系统.md">配置系统</a> 了解如何自定义参数</li>
<li>参考 <a href="09_示例教程.md">示例教程</a> 查看实际应用</li>
</ul>
            </section>

            <section id="section-7" class="section">
                <h1 id="_1">配置系统<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>mlp-train 使用 <code>Config</code> 类来管理全局配置参数。本章节详细介绍如何配置和使用这些参数。</p>
<h2 id="config">Config 类概述<a class="headerlink" href="#config" title="Permanent link">&para;</a></h2>
<p><code>Config</code> 是一个单例类，包含所有默认配置参数：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 访问配置</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">)</span>
</code></pre></div>

<h2 id="_2">基本配置<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">并行计算核心数<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># 使用 10 个核心</span>
</code></pre></div>

<p><strong>注意</strong>：在主动学习中，<code>n_cores</code> 必须是 <code>n_configs_iter</code> 的倍数。</p>
<h3 id="_4">量子化学方法配置<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<h4 id="orca">ORCA 配置<a class="headerlink" href="#orca" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="s1">&#39;def2-SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;EnGrad&#39;</span><span class="p">]</span>
</code></pre></div>

<p>常用关键词组合：<br />
- <strong>PBE/def2-SVP</strong>：快速 DFT 计算<br />
- <strong>PBE0/def2-TZVP</strong>：更精确但更慢<br />
- <strong>B3LYP/6-31G(d)</strong>：常用混合泛函</p>
<h4 id="gaussian">Gaussian 配置<a class="headerlink" href="#gaussian" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">gaussian_keywords</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;PBEPBE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Def2SVP&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Force(NoStep)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;integral=ultrafinegrid&#39;</span>
<span class="p">]</span>
</code></pre></div>

<h2 id="_5">模型特定配置<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="gap">GAP 参数<a class="headerlink" href="#gap" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># GAP 默认参数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">gap_default_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sigma_E&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">4.0</span><span class="p">),</span>  <span class="c1"># 能量噪声（eV）</span>
    <span class="s1">&#39;sigma_F&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">),</span>  <span class="c1"># 力噪声（eV Å⁻¹）</span>
<span class="p">}</span>

<span class="c1"># GAP SOAP 参数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">gap_default_soap_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>      <span class="c1"># 截断半径（Å）</span>
    <span class="s1">&#39;n_sparse&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>   <span class="c1"># 稀疏点数量</span>
    <span class="s1">&#39;l_max&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>         <span class="c1"># 角动量量子数（n_max = 2*l_max）</span>
    <span class="s1">&#39;sigma_at&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>    <span class="c1"># 原子宽度（Å）</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="ace">ACE 参数<a class="headerlink" href="#ace" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">ace_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>              <span class="c1"># 最大相关阶数</span>
    <span class="s1">&#39;r_cut&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>       <span class="c1"># 外截断半径（Å）</span>
    <span class="s1">&#39;deg_pair&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>      <span class="c1"># 对势阶数</span>
    <span class="s1">&#39;r_cut_pair&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>  <span class="c1"># 对势截断半径（Å）</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="mace">MACE 参数<a class="headerlink" href="#mace" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;valid_fraction&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>           <span class="c1"># 验证集比例</span>
    <span class="s1">&#39;max_num_epochs&#39;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>          <span class="c1"># 最大训练轮数</span>
    <span class="s1">&#39;config_type_weights&#39;</span><span class="p">:</span> <span class="s1">&#39;{&quot;Default&quot;:1.0}&#39;</span><span class="p">,</span>
    <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="s1">&#39;MACE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;loss&#39;</span><span class="p">:</span> <span class="s1">&#39;weighted&#39;</span><span class="p">,</span>
    <span class="s1">&#39;energy_weight&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>            <span class="c1"># 能量权重</span>
    <span class="s1">&#39;forces_weight&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>            <span class="c1"># 力权重</span>
    <span class="s1">&#39;hidden_irreps&#39;</span><span class="p">:</span> <span class="s1">&#39;128x0e + 128x1o&#39;</span><span class="p">,</span>
    <span class="s1">&#39;batch_size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;r_max&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>                    <span class="c1"># 截断半径（Å）</span>
    <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;device&#39;</span><span class="p">:</span> <span class="s1">&#39;cuda&#39;</span><span class="p">,</span>                 <span class="c1"># &#39;cuda&#39; 或 &#39;cpu&#39;</span>
    <span class="s1">&#39;calc_device&#39;</span><span class="p">:</span> <span class="s1">&#39;cpu&#39;</span><span class="p">,</span>
    <span class="s1">&#39;error_table&#39;</span><span class="p">:</span> <span class="s1">&#39;TotalMAE&#39;</span><span class="p">,</span>
    <span class="s1">&#39;swa&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>                      <span class="c1"># 随机权重平均</span>
    <span class="s1">&#39;start_swa&#39;</span><span class="p">:</span> <span class="mi">800</span><span class="p">,</span>
    <span class="s1">&#39;ema&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>                      <span class="c1"># 指数移动平均</span>
    <span class="s1">&#39;ema_decay&#39;</span><span class="p">:</span> <span class="mf">0.99</span><span class="p">,</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.001</span><span class="p">,</span>                      <span class="c1"># 学习率</span>
    <span class="s1">&#39;patience&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s1">&#39;scheduler_patience&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s1">&#39;seed&#39;</span><span class="p">:</span> <span class="mi">345</span><span class="p">,</span>
    <span class="s1">&#39;amsgrad&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;restart_latest&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;save_cpu&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;num_workers&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="s1">&#39;max_L&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;dtype&#39;</span><span class="p">:</span> <span class="s1">&#39;float32&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cueq&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="mace_1">MACE 设备配置<a class="headerlink" href="#mace_1" title="Permanent link">&para;</a></h3>
<p>MACE 会自动检测 CUDA 是否可用：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 自动检测（默认）</span>
<span class="c1"># mlt.Config.mace_params[&#39;device&#39;] 会自动设置为 &#39;cuda&#39; 或 &#39;cpu&#39;</span>

<span class="c1"># 手动设置</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>  <span class="c1"># 使用 GPU</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>   <span class="c1"># 使用 CPU</span>
</code></pre></div>

<h2 id="_6">自定义配置示例<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="1-gap">示例 1：高精度 GAP<a class="headerlink" href="#1-gap" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 设置更严格的噪声参数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">gap_default_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sigma_E&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">),</span>  <span class="c1"># 更小的能量噪声</span>
    <span class="s1">&#39;sigma_F&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="p">),</span>  <span class="c1"># 更小的力噪声</span>
<span class="p">}</span>

<span class="c1"># 使用更大的 SOAP 描述符</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">gap_default_soap_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;cutoff&#39;</span><span class="p">:</span> <span class="mf">6.0</span><span class="p">,</span>      <span class="c1"># 更大的截断半径</span>
    <span class="s1">&#39;n_sparse&#39;</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>   <span class="c1"># 更多的稀疏点</span>
    <span class="s1">&#39;l_max&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>         <span class="c1"># 更高的角动量</span>
    <span class="s1">&#39;sigma_at&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>    <span class="c1"># 更小的原子宽度</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2-mace">示例 2：快速 MACE 训练<a class="headerlink" href="#2-mace" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 减少训练轮数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="p">[</span><span class="s1">&#39;max_num_epochs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">600</span>

<span class="c1"># 增大批次大小（如果内存允许）</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="p">[</span><span class="s1">&#39;batch_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># 使用 GPU</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>
</code></pre></div>

<h3 id="3">示例 3：多核并行<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 设置核心数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">20</span>

<span class="c1"># 确保 n_configs_iter 是 n_cores 的约数</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">10</span>  <span class="c1"># 20 是 10 的倍数，OK</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_7">配置验证<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="_8">检查配置<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 打印所有配置</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">gap_default_params</span><span class="p">)</span>
</code></pre></div>

<h3 id="_9">重置为默认值<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 重新导入以重置（不推荐）</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">mlptrain</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># 或手动重置</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>

<h2 id="_10">环境变量<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<p>某些配置可以通过环境变量设置：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 设置 OMP 线程数</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">4</span>

<span class="c1"># 设置 CUDA 设备</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">CUDA_VISIBLE_DEVICES</span><span class="o">=</span><span class="m">0</span>
</code></pre></div>

<h2 id="_11">配置文件<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>虽然 mlp-train 不直接支持配置文件，但您可以在 Python 脚本中集中管理配置：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># config.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="c1"># 项目特定配置</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="s1">&#39;def2-SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;EnGrad&#39;</span><span class="p">]</span>

<span class="c1"># 自定义 MACE 参数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;max_num_epochs&#39;</span><span class="p">:</span> <span class="mi">1500</span><span class="p">,</span>
    <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.0005</span><span class="p">,</span>
<span class="p">})</span>

<span class="c1"># 在主脚本中导入</span>
<span class="c1"># from config import *  # 应用配置</span>
</code></pre></div>

<h2 id="_12">最佳实践<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p><strong>在脚本开头设置配置</strong>：<br />
<code>python
   import mlptrain as mlt
   mlt.Config.n_cores = 10
   mlt.Config.orca_keywords = ['PBE', 'def2-SVP', 'EnGrad']</code></p>
</li>
<li>
<p><strong>根据系统调整参数</strong>：</p>
</li>
<li>小系统：可以使用更精确的参数</li>
<li>
<p>大系统：可能需要更快的参数</p>
</li>
<li>
<p><strong>测试配置</strong>：</p>
</li>
<li>先用小规模测试验证配置</li>
<li>
<p>再应用到大规模计算</p>
</li>
<li>
<p><strong>文档化配置</strong>：</p>
</li>
<li>在脚本中注释说明配置选择</li>
<li>记录参数调整的原因</li>
</ol>
<h2 id="_13">常见配置问题<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<h3 id="1n_cores-n_configs_iter">问题 1：n_cores 与 n_configs_iter 不匹配<a class="headerlink" href="#1n_cores-n_configs_iter" title="Permanent link">&para;</a></h3>
<p><strong>错误</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nx">Active</span><span class="w"> </span><span class="nx">learning</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">only</span><span class="w"> </span><span class="nx">implemented</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">multiple</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="nx">n_configs_iter</span><span class="p">.</span>
</code></pre></div>

<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 确保 n_cores 是 n_configs_iter 的倍数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 10 是 5 的倍数，OK</span>
</code></pre></div>

<h3 id="2orcagaussian">问题 2：ORCA/Gaussian 未配置<a class="headerlink" href="#2orcagaussian" title="Permanent link">&para;</a></h3>
<p><strong>错误</strong>：</p>
<div class="highlight"><pre><span></span><code>ORCA keywords must be gradient
</code></pre></div>

<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="s1">&#39;def2-SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;EnGrad&#39;</span><span class="p">]</span>
<span class="c1"># 或</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">gaussian_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBEPBE&#39;</span><span class="p">,</span> <span class="s1">&#39;Def2SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;Force(NoStep)&#39;</span><span class="p">]</span>
</code></pre></div>

<h3 id="3mace-cuda">问题 3：MACE CUDA 不可用<a class="headerlink" href="#3mace-cuda" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 CUDA</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="c1"># 如果不可用，使用 CPU</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
</code></pre></div>

<h2 id="_14">下一步<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h2>
<ul>
<li>查看 <a href="10_API参考.md">API 参考</a> 了解详细 API</li>
<li>参考 <a href="09_示例教程.md">示例教程</a> 查看实际应用</li>
</ul>
            </section>

            <section id="section-8" class="section">
                <h1 id="_1">示例教程<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>本章节详细介绍 mlp-train 提供的各种示例，帮助您理解如何在实际应用中使用该包。</p>
<h2 id="_2">基础示例<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="1-waterpy">1. 水分子（water.py）<a class="headerlink" href="#1-waterpy" title="Permanent link">&para;</a></h3>
<p>最简单的示例，演示如何使用 GAP 训练水分子势能。</p>
<p><strong>文件位置</strong>：<code>examples/water.py</code></p>
<p><strong>关键特性</strong>：<br />
- 使用 ACE 模型<br />
- 使用 SOAP 描述符和原子环境相似性选择器<br />
- 运行 MD 模拟</p>
<p><strong>代码要点</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.training.selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">AtomicEnvSimilarity</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.descriptor</span><span class="w"> </span><span class="kn">import</span> <span class="n">SoapDescriptor</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">ace</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">ACE</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 使用自定义描述符和选择器</span>
<span class="n">descriptor</span> <span class="o">=</span> <span class="n">SoapDescriptor</span><span class="p">(</span><span class="n">average</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span> <span class="n">r_cut</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span> <span class="n">n_max</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">l_max</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="n">selector</span> <span class="o">=</span> <span class="n">AtomicEnvSimilarity</span><span class="p">(</span><span class="n">descriptor</span><span class="o">=</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.9995</span><span class="p">)</span>
<span class="n">ace</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span> <span class="n">selection_method</span><span class="o">=</span><span class="n">selector</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># 运行 MD</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">ace</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;water_trajectory.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2-methanepy">2. 甲烷（methane.py）<a class="headerlink" href="#2-methanepy" title="Permanent link">&para;</a></h3>
<p>演示使用 GAP 训练简单分子。</p>
<p><strong>文件位置</strong>：<code>examples/methane.py</code></p>
<p><strong>关键特性</strong>：<br />
- 使用 GAP 模型<br />
- 使用 ORCA 作为参考方法<br />
- 轨迹比较和可视化</p>
<p><strong>代码要点</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="s1">&#39;def2-SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;EnGrad&#39;</span><span class="p">]</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;methane.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;methane&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 主动学习训练</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># 运行 MD</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 比较预测与真实值</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="3-openmmwater_openmmpy">3. 水分子（OpenMM）（water_openmm.py）<a class="headerlink" href="#3-openmmwater_openmmpy" title="Permanent link">&para;</a></h3>
<p>演示如何使用 OpenMM 后端运行 MD 模拟。</p>
<p><strong>文件位置</strong>：<code>examples/water_openmm.py</code></p>
<p><strong>关键特性</strong>：<br />
- 使用 MACE 模型<br />
- 使用 OpenMM 进行 MD 模拟<br />
- 在主动学习中使用 OpenMM</p>
<p><strong>代码要点</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">mace</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">MACE</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="c1"># 使用 OpenMM 进行主动学习</span>
<span class="n">mace</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">max_active_iters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">max_active_time</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">md_program</span><span class="o">=</span><span class="s1">&#39;OpenMM&#39;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 使用 OpenMM 运行 MD</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md_openmm</span><span class="o">.</span><span class="n">run_mlp_md_openmm</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">mace</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;water_trajectory.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_3">反应示例<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="4-diels-alder-da_tspy">4. Diels-Alder 反应（da_ts.py）<a class="headerlink" href="#4-diels-alder-da_tspy" title="Permanent link">&para;</a></h3>
<p>演示如何训练反应过渡态的势能。</p>
<p><strong>文件位置</strong>：<code>examples/da_ts.py</code></p>
<p><strong>关键特性</strong>：<br />
- 过渡态结构训练<br />
- 使用原子环境相似性选择器<br />
- 固定初始构型</p>
<p><strong>代码要点</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBE0&#39;</span><span class="p">,</span> <span class="s1">&#39;def2-SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;EnGrad&#39;</span><span class="p">]</span>

<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;da_ts.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;da&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>

<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>  <span class="c1"># 较低温度，适合过渡态</span>
    <span class="n">selection_method</span><span class="o">=</span><span class="n">mlt</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">AtomicEnvSimilarity</span><span class="p">(),</span>
    <span class="n">max_active_time</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">fix_init_config</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 固定初始构型</span>
<span class="p">)</span>

<span class="c1"># 运行低温 MD 验证</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">configuration</span><span class="p">,</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># 低温</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_4">高级采样示例<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="5-metadynamics">5. 元动力学（metadynamics/）<a class="headerlink" href="#5-metadynamics" title="Permanent link">&para;</a></h3>
<p>演示如何使用元动力学进行增强采样。</p>
<p><strong>目录位置</strong>：<code>examples/metadynamics/</code></p>
<h4 id="h2-h2h2py">H₂ 系统（h2/h2.py）<a class="headerlink" href="#h2-h2h2py" title="Permanent link">&para;</a></h4>
<p><strong>关键特性</strong>：<br />
- 简单双原子系统<br />
- 一维元动力学<br />
- 自由能计算</p>
<h4 id="h2o-h2oh2opy">H₂O 系统（h2o/h2o.py）<a class="headerlink" href="#h2o-h2oh2opy" title="Permanent link">&para;</a></h4>
<p><strong>关键特性</strong>：<br />
- 三原子系统<br />
- 多 CV 元动力学<br />
- 自由能面计算</p>
<h3 id="6-umbrella">6. 伞形采样（umbrella/）<a class="headerlink" href="#6-umbrella" title="Permanent link">&para;</a></h3>
<p>演示如何使用伞形采样计算自由能。</p>
<p><strong>目录位置</strong>：<code>examples/umbrella/</code></p>
<p><strong>关键特性</strong>：<br />
- 定义反应坐标<br />
- 设置多个窗口<br />
- WHAM 分析</p>
<p><strong>代码结构</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mlptrain.sampling.reaction_coord</span><span class="w"> </span><span class="kn">import</span> <span class="n">AverageDistance</span>

<span class="c1"># 定义反应坐标</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">AverageDistance</span><span class="p">(</span><span class="n">atom_idxs</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="c1"># 创建伞形采样对象</span>
<span class="n">umbrella</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">UmbrellaSampling</span><span class="p">(</span><span class="n">cvs</span><span class="o">=</span><span class="p">[</span><span class="n">cv</span><span class="p">],</span> <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

<span class="c1"># 定义窗口</span>
<span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">]</span>
<span class="n">kappas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>

<span class="c1"># 运行伞形采样</span>
<span class="n">umbrella</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">configurations</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">],</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">windows</span><span class="o">=</span><span class="n">windows</span><span class="p">,</span>
    <span class="n">kappas</span><span class="o">=</span><span class="n">kappas</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 计算自由能</span>
<span class="n">free_energy</span> <span class="o">=</span> <span class="n">umbrella</span><span class="o">.</span><span class="n">compute_free_energy</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;wham&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_5">论文示例<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="7-da-da_paper">7. DA 论文示例（DA_paper/）<a class="headerlink" href="#7-da-da_paper" title="Permanent link">&para;</a></h3>
<p>包含 Diels-Alder 反应研究的完整示例。</p>
<p><strong>目录位置</strong>：<code>examples/DA_paper/</code></p>
<p><strong>子目录</strong>：<br />
- <code>training/</code>：训练脚本<br />
- <code>uphill/</code>：上坡采样<br />
- <code>1d_fes/</code>：一维自由能面<br />
- <code>2D_pes/</code>：二维势能面</p>
<h3 id="8-wtmetad-wtmetad_paper">8. WTMetaD 论文示例（WTMetaD_paper/）<a class="headerlink" href="#8-wtmetad-wtmetad_paper" title="Permanent link">&para;</a></h3>
<p>包含良好调温元动力学研究的示例。</p>
<p><strong>目录位置</strong>：<code>examples/WTMetaD_paper/</code></p>
<p><strong>关键特性</strong>：<br />
- 良好调温元动力学<br />
- 自由能计算<br />
- 主动学习结合</p>
<h3 id="9-inherited_bias_active_learning">9. 继承偏置主动学习（inherited_bias_active_learning/）<a class="headerlink" href="#9-inherited_bias_active_learning" title="Permanent link">&para;</a></h3>
<p>演示如何在主动学习中继承元动力学偏置。</p>
<p><strong>目录位置</strong>：<code>examples/inherited_bias_active_learning/</code></p>
<p><strong>关键特性</strong>：<br />
- 元动力学偏置继承<br />
- 加速构型空间探索<br />
- 提高训练效率</p>
<h2 id="_6">运行示例<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="_7">基本步骤<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p><strong>进入示例目录</strong>：<br />
<code>bash
   cd examples</code></p>
</li>
<li>
<p><strong>准备输入文件</strong>：</p>
</li>
<li>确保所需的 XYZ 文件存在</li>
<li>
<p>检查量子化学软件配置</p>
</li>
<li>
<p><strong>激活环境</strong>：<br />
<code>bash
   conda activate mlp-train-gap  # 或其他模型环境</code></p>
</li>
<li>
<p><strong>运行脚本</strong>：<br />
<code>bash
   python water.py</code></p>
</li>
</ol>
<h3 id="_8">修改示例<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<p>在运行示例前，您可能需要：</p>
<ol>
<li>
<p><strong>调整核心数</strong>：<br />
<code>python
   mlt.Config.n_cores = 4  # 根据您的系统调整</code></p>
</li>
<li>
<p><strong>修改参考方法</strong>：<br />
<code>python
   # 如果 ORCA 未安装，使用 xTB
   gap.al_train(method_name='xtb', temp=500)</code></p>
</li>
<li>
<p><strong>减少迭代次数</strong>（用于测试）：<br />
<code>python
   gap.al_train(
       method_name='xtb',
       temp=500,
       max_active_iters=2,  # 减少迭代次数
       n_configs_iter=3,     # 减少每次迭代的构型数
   )</code></p>
</li>
</ol>
<h2 id="_9">示例选择指南<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>根据您的需求选择合适的示例：</p>
<ul>
<li><strong>初学者</strong>：从 <code>water.py</code> 或 <code>methane.py</code> 开始</li>
<li><strong>反应研究</strong>：查看 <code>da_ts.py</code> 和 <code>DA_paper/</code></li>
<li><strong>自由能计算</strong>：参考 <code>metadynamics/</code> 和 <code>umbrella/</code></li>
<li><strong>大规模系统</strong>：使用 <code>water_openmm.py</code>（MACE + OpenMM）</li>
<li><strong>高级应用</strong>：查看 <code>paper_examples/</code> 和 <code>WTMetaD_paper/</code></li>
</ul>
<h2 id="_10">常见问题<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<h3 id="1">问题 1：示例无法运行<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p><strong>可能原因</strong>：<br />
- 缺少输入文件<br />
- 量子化学软件未配置<br />
- 环境未激活</p>
<p><strong>解决方案</strong>：<br />
1. 检查输入文件是否存在<br />
2. 验证软件配置<br />
3. 确保激活了正确的 conda 环境</p>
<h3 id="2">问题 2：计算时间过长<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：<br />
- 减少 <code>max_active_iters</code><br />
- 减少 <code>n_configs_iter</code><br />
- 使用更快的参考方法（如 xTB）</p>
<h3 id="3">问题 3：内存不足<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：<br />
- 减少 <code>n_configs_iter</code><br />
- 使用更小的系统进行测试<br />
- 减少并行核心数</p>
<h2 id="_11">下一步<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<ul>
<li>查看 <a href="10_API参考.md">API 参考</a> 了解详细 API</li>
<li>参考 <a href="12_最佳实践.md">最佳实践</a> 优化您的使用</li>
</ul>
            </section>

            <section id="section-9" class="section">
                <h1 id="api">API 参考<a class="headerlink" href="#api" title="Permanent link">&para;</a></h1>
<p>本章节提供 mlp-train 主要类和函数的 API 参考。</p>
<h2 id="_1">核心类<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<h3 id="system">System<a class="headerlink" href="#system" title="Permanent link">&para;</a></h3>
<p>表示一个完整的系统，包含分子和可能的周期性边界条件。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

<p><strong>参数</strong>：<br />
- <code>molecule</code> (Molecule)：分子对象<br />
- <code>box</code> (Box, optional)：周期性盒子</p>
<p><strong>方法</strong>：<br />
- <code>random_configuration()</code>：生成随机构型<br />
- <code>configuration()</code>：生成特定构型</p>
<h3 id="molecule">Molecule<a class="headerlink" href="#molecule" title="Permanent link">&para;</a></h3>
<p>表示一个分子。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p><strong>参数</strong>：<br />
- <code>filename</code> (str)：XYZ 文件路径<br />
- <code>charge</code> (int)：电荷<br />
- <code>mult</code> (int)：自旋多重度</p>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<p>表示系统在某一时刻的构型。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Configuration</span><span class="p">(</span><span class="n">atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

<p><strong>属性</strong>：<br />
- <code>atoms</code>：原子列表<br />
- <code>energy</code>：能量对象（Energy）<br />
- <code>forces</code>：力对象（Forces）<br />
- <code>box</code>：周期性盒子<br />
- <code>charge</code>：电荷<br />
- <code>mult</code>：自旋多重度</p>
<p><strong>方法</strong>：<br />
- <code>save_xyz(filename)</code>：保存为 XYZ 格式<br />
- <code>single_point(method_name)</code>：单点计算</p>
<h3 id="configurationset">ConfigurationSet<a class="headerlink" href="#configurationset" title="Permanent link">&para;</a></h3>
<p>构型集合，用于管理训练数据。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">ConfigurationSet</span><span class="p">(</span><span class="n">configurations</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

<p><strong>方法</strong>：<br />
- <code>save_xyz(filename)</code>：保存所有构型<br />
- <code>remove_above_e(threshold)</code>：移除高能构型<br />
- <code>has_a_none_energy</code>：检查是否有未计算能量的构型</p>
<h3 id="trajectory">Trajectory<a class="headerlink" href="#trajectory" title="Permanent link">&para;</a></h3>
<p>分子动力学轨迹，继承自 ConfigurationSet。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Trajectory</span><span class="p">(</span><span class="n">configurations</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

<p><strong>方法</strong>：<br />
- <code>save(filename)</code>：保存轨迹<br />
- <code>compare(mlp, method_name)</code>：比较预测与真实值<br />
- <code>plot()</code>：绘制轨迹</p>
<h3 id="box">Box<a class="headerlink" href="#box" title="Permanent link">&para;</a></h3>
<p>周期性边界条件的盒子。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</code></pre></div>

<p><strong>参数</strong>：<br />
- <code>size</code> (list)：盒子尺寸 [x, y, z]（Å）</p>
<h2 id="_2">机器学习势能<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="mlpotential">MLPotential（基类）<a class="headerlink" href="#mlpotential" title="Permanent link">&para;</a></h3>
<p>所有 MLP 模型的基类。</p>
<p><strong>属性</strong>：<br />
- <code>name</code>：势能名称<br />
- <code>system</code>：关联的系统<br />
- <code>training_data</code>：训练数据集</p>
<p><strong>方法</strong>：<br />
- <code>al_train(...)</code>：主动学习训练<br />
- <code>train(configurations)</code>：使用给定数据集训练<br />
- <code>predict(configuration)</code>：预测能量和力<br />
- <code>save()</code>：保存模型<br />
- <code>load()</code>：加载模型</p>
<h3 id="gap">GAP<a class="headerlink" href="#gap" title="Permanent link">&para;</a></h3>
<p>Gaussian Approximation Potential。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">system</span><span class="p">)</span>
</code></pre></div>

<h3 id="ace">ACE<a class="headerlink" href="#ace" title="Permanent link">&para;</a></h3>
<p>Atomic Cluster Expansion。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">ACE</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">system</span><span class="p">)</span>
</code></pre></div>

<h3 id="mace">MACE<a class="headerlink" href="#mace" title="Permanent link">&para;</a></h3>
<p>Multi-ACE。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">MACE</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">system</span><span class="p">)</span>
</code></pre></div>

<h2 id="_3">主动学习<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="al_train">al_train<a class="headerlink" href="#al_train" title="Permanent link">&para;</a></h3>
<p>主动学习训练函数。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlp</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="p">,</span>              <span class="c1"># 参考方法名称</span>
    <span class="n">selection_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># 选择方法</span>
    <span class="n">max_active_time</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>     <span class="c1"># 最大时间（fs）</span>
    <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>       <span class="c1"># 每次迭代的构型数</span>
    <span class="n">temp</span><span class="o">=</span><span class="mf">300.0</span><span class="p">,</span>              <span class="c1"># 温度（K）</span>
    <span class="n">max_e_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>    <span class="c1"># 最大能量阈值</span>
    <span class="n">max_active_iters</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>     <span class="c1"># 最大迭代次数</span>
    <span class="n">n_init_configs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>      <span class="c1"># 初始构型数</span>
    <span class="n">init_configs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>      <span class="c1"># 预定义初始构型</span>
    <span class="n">fix_init_config</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>   <span class="c1"># 固定初始构型</span>
    <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>               <span class="c1"># 偏置势</span>
    <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>        <span class="c1"># 约束</span>
    <span class="n">md_program</span><span class="o">=</span><span class="s1">&#39;ASE&#39;</span><span class="p">,</span>        <span class="c1"># MD 程序</span>
    <span class="n">pbc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>               <span class="c1"># 周期性边界条件</span>
    <span class="n">box_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>           <span class="c1"># 盒子尺寸</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_4">分子动力学<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="run_mlp_md">run_mlp_md<a class="headerlink" href="#run_mlp_md" title="Permanent link">&para;</a></h3>
<p>使用 ASE 运行 MD 模拟。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="p">,</span>           <span class="c1"># 起始构型</span>
    <span class="n">mlp</span><span class="p">,</span>                    <span class="c1"># MLP 模型</span>
    <span class="n">temp</span><span class="p">,</span>                   <span class="c1"># 温度（K）</span>
    <span class="n">dt</span><span class="p">,</span>                     <span class="c1"># 时间步长（fs）</span>
    <span class="n">interval</span><span class="p">,</span>               <span class="c1"># 保存间隔（步数）</span>
    <span class="n">pressure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>          <span class="c1"># 压力（bar，NPT）</span>
    <span class="n">compress</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>          <span class="c1"># 压缩率（bar⁻¹，NPT）</span>
    <span class="n">init_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>         <span class="c1"># 初始温度（K）</span>
    <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>              <span class="c1"># 偏置势</span>
    <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>       <span class="c1"># 约束</span>
    <span class="n">restart_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>      <span class="c1"># 重启文件</span>
    <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                <span class="c1"># 模拟时间（fs）</span>
    <span class="n">ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                <span class="c1"># 模拟时间（ps）</span>
    <span class="n">ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                <span class="c1"># 模拟时间（ns）</span>
    <span class="n">save_fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>           <span class="c1"># 保存间隔（fs）</span>
    <span class="n">save_ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>           <span class="c1"># 保存间隔（ps）</span>
    <span class="n">save_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>           <span class="c1"># 保存间隔（ns）</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="run_mlp_md_openmm">run_mlp_md_openmm<a class="headerlink" href="#run_mlp_md_openmm" title="Permanent link">&para;</a></h3>
<p>使用 OpenMM 运行 MD 模拟。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">md_openmm</span><span class="o">.</span><span class="n">run_mlp_md_openmm</span><span class="p">(</span>
    <span class="n">configuration</span><span class="p">,</span>           <span class="c1"># 起始构型</span>
    <span class="n">mlp</span><span class="p">,</span>                     <span class="c1"># MLP 模型</span>
    <span class="n">temp</span><span class="p">,</span>                    <span class="c1"># 温度（K）</span>
    <span class="n">dt</span><span class="p">,</span>                      <span class="c1"># 时间步长（fs）</span>
    <span class="n">interval</span><span class="p">,</span>                <span class="c1"># 保存间隔（步数）</span>
    <span class="n">init_temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>          <span class="c1"># 初始温度（K）</span>
    <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>               <span class="c1"># 偏置势</span>
    <span class="n">restart_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>      <span class="c1"># 重启文件</span>
    <span class="n">platform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>           <span class="c1"># OpenMM 平台</span>
    <span class="n">fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                 <span class="c1"># 模拟时间（fs）</span>
    <span class="n">ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                 <span class="c1"># 模拟时间（ps）</span>
    <span class="n">ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>                 <span class="c1"># 模拟时间（ns）</span>
    <span class="n">save_fs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>            <span class="c1"># 保存间隔（fs）</span>
    <span class="n">save_ps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>            <span class="c1"># 保存间隔（ps）</span>
    <span class="n">save_ns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>            <span class="c1"># 保存间隔（ns）</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_5">选择方法<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="absdiffe">AbsDiffE<a class="headerlink" href="#absdiffe" title="Permanent link">&para;</a></h3>
<p>基于能量绝对误差的选择方法。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">AbsDiffE</span><span class="p">(</span><span class="n">e_thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</code></pre></div>

<p><strong>参数</strong>：<br />
- <code>e_thresh</code> (float)：能量阈值（eV）</p>
<h3 id="atomicenvsimilarity">AtomicEnvSimilarity<a class="headerlink" href="#atomicenvsimilarity" title="Permanent link">&para;</a></h3>
<p>基于原子环境相似性的选择方法。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">AtomicEnvSimilarity</span><span class="p">(</span><span class="n">descriptor</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.999</span><span class="p">)</span>
</code></pre></div>

<p><strong>参数</strong>：<br />
- <code>descriptor</code>：描述符对象（如 SoapDescriptor）<br />
- <code>threshold</code> (float)：相似性阈值</p>
<h3 id="atomicenvdistance">AtomicEnvDistance<a class="headerlink" href="#atomicenvdistance" title="Permanent link">&para;</a></h3>
<p>基于局部异常因子的选择方法。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">selection</span><span class="o">.</span><span class="n">AtomicEnvDistance</span><span class="p">(</span>
    <span class="n">descriptor</span><span class="p">,</span>
    <span class="n">pca</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">distance_metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span>
    <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">15</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_6">高级采样<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="metadynamics">Metadynamics<a class="headerlink" href="#metadynamics" title="Permanent link">&para;</a></h3>
<p>元动力学类。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Metadynamics</span><span class="p">(</span><span class="n">cvs</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>

<p><strong>方法</strong>：<br />
- <code>run_mlp_md(...)</code>：运行元动力学 MD<br />
- <code>estimate_width(...)</code>：估计高斯宽度<br />
- <code>compute_free_energy(...)</code>：计算自由能</p>
<h3 id="umbrellasampling">UmbrellaSampling<a class="headerlink" href="#umbrellasampling" title="Permanent link">&para;</a></h3>
<p>伞形采样类。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">UmbrellaSampling</span><span class="p">(</span><span class="n">cvs</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
</code></pre></div>

<p><strong>方法</strong>：<br />
- <code>run(...)</code>：运行伞形采样<br />
- <code>compute_free_energy(method='wham')</code>：计算自由能<br />
- <code>plot_free_energy()</code>：绘制自由能曲线</p>
<h2 id="_7">反应坐标<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="averagedistance">AverageDistance<a class="headerlink" href="#averagedistance" title="Permanent link">&para;</a></h3>
<p>平均距离反应坐标。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">AverageDistance</span><span class="p">(</span><span class="n">atom_idxs</span><span class="p">)</span>
</code></pre></div>

<h3 id="differencedistance">DifferenceDistance<a class="headerlink" href="#differencedistance" title="Permanent link">&para;</a></h3>
<p>距离差反应坐标。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">DifferenceDistance</span><span class="p">(</span><span class="n">atom_idxs1</span><span class="p">,</span> <span class="n">atom_idxs2</span><span class="p">)</span>
</code></pre></div>

<h2 id="plumed">PLUMED 集体变量<a class="headerlink" href="#plumed" title="Permanent link">&para;</a></h2>
<h3 id="plumedaveragecv">PlumedAverageCV<a class="headerlink" href="#plumedaveragecv" title="Permanent link">&para;</a></h3>
<p>PLUMED 平均距离 CV。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">PlumedAverageCV</span><span class="p">(</span><span class="n">atom_idxs</span><span class="p">)</span>
</code></pre></div>

<h3 id="plumeddifferencecv">PlumedDifferenceCV<a class="headerlink" href="#plumeddifferencecv" title="Permanent link">&para;</a></h3>
<p>PLUMED 距离差 CV。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">PlumedDifferenceCV</span><span class="p">(</span><span class="n">atom_idxs1</span><span class="p">,</span> <span class="n">atom_idxs2</span><span class="p">)</span>
</code></pre></div>

<h3 id="plumedcncv">PlumedCNCV<a class="headerlink" href="#plumedcncv" title="Permanent link">&para;</a></h3>
<p>PLUMED 配位数 CV。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">PlumedCNCV</span><span class="p">(</span><span class="n">atom_idxs</span><span class="p">,</span> <span class="n">r_0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</code></pre></div>

<h3 id="plumedcustomcv">PlumedCustomCV<a class="headerlink" href="#plumedcustomcv" title="Permanent link">&para;</a></h3>
<p>自定义 PLUMED CV。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">PlumedCustomCV</span><span class="p">(</span><span class="n">plumed_cv_string</span><span class="p">)</span>
</code></pre></div>

<h2 id="_8">偏置<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="bias">Bias<a class="headerlink" href="#bias" title="Permanent link">&para;</a></h3>
<p>简单偏置势。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">Bias</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
</code></pre></div>

<p><strong>参数</strong>：<br />
- <code>cv</code>：反应坐标<br />
- <code>kappa</code> (float)：弹簧常数（eV/单位²）<br />
- <code>ref</code> (float)：参考值</p>
<h3 id="plumedbias">PlumedBias<a class="headerlink" href="#plumedbias" title="Permanent link">&para;</a></h3>
<p>PLUMED 偏置势。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">PlumedBias</span><span class="p">(</span><span class="n">cvs</span><span class="p">,</span> <span class="n">from_file</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<h2 id="_9">配置<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<h3 id="config">Config<a class="headerlink" href="#config" title="Permanent link">&para;</a></h3>
<p>全局配置类。</p>
<p><strong>属性</strong>：<br />
- <code>n_cores</code> (int)：并行核心数<br />
- <code>orca_keywords</code> (list)：ORCA 关键词<br />
- <code>gaussian_keywords</code> (list)：Gaussian 关键词<br />
- <code>gap_default_params</code> (dict)：GAP 默认参数<br />
- <code>ace_params</code> (dict)：ACE 参数<br />
- <code>mace_params</code> (dict)：MACE 参数</p>
<h2 id="_10">工具函数<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<h3 id="convert_ase_time">convert_ase_time<a class="headerlink" href="#convert_ase_time" title="Permanent link">&para;</a></h3>
<p>转换 ASE 时间单位。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">convert_ase_time</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">)</span>
</code></pre></div>

<h3 id="convert_ase_energy">convert_ase_energy<a class="headerlink" href="#convert_ase_energy" title="Permanent link">&para;</a></h3>
<p>转换 ASE 能量单位。</p>
<div class="highlight"><pre><span></span><code><span class="n">mlt</span><span class="o">.</span><span class="n">convert_ase_energy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">from_unit</span><span class="p">,</span> <span class="n">to_unit</span><span class="p">)</span>
</code></pre></div>

<h2 id="_11">下一步<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<ul>
<li>查看 <a href="11_常见问题.md">常见问题</a> 解决使用中的问题</li>
<li>参考 <a href="12_最佳实践.md">最佳实践</a> 优化您的使用</li>
</ul>
            </section>

            <section id="section-10" class="section">
                <h1 id="_1">常见问题<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>本章节回答使用 mlp-train 时遇到的常见问题。</p>
<h2 id="_2">安装问题<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="q1-ace-julia">Q1: 安装 ACE 时提示找不到 Julia<a class="headerlink" href="#q1-ace-julia" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：运行 <code>./install_ace.sh</code> 时出现 "Julia not found" 错误。</p>
<p><strong>解决方案</strong>：<br />
1. 确保已安装 Julia（版本 &gt;= 1.6）<br />
2. 检查 Julia 是否在 PATH 中：<br />
<code>bash
   which julia</code><br />
3. 如果未找到，将 Julia 添加到 PATH：<br />
<code>bash
   export PATH=$PATH:/path/to/julia/bin</code></p>
<h3 id="q2-mace-cuda">Q2: MACE 安装时 CUDA 相关错误<a class="headerlink" href="#q2-mace-cuda" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：MACE 安装时出现 CUDA 版本不兼容错误。</p>
<p><strong>解决方案</strong>：<br />
1. 检查 CUDA 驱动版本：<br />
<code>bash
   nvidia-smi</code><br />
2. 使用 <code>CONDA_OVERRIDE_CUDA</code> 指定兼容版本：<br />
<code>bash
   CONDA_OVERRIDE_CUDA="11.2" ./install_mace.sh</code><br />
3. 如果不需要 GPU，可以安装 CPU 版本（默认）</p>
<h3 id="q3">Q3: 权限错误<a class="headerlink" href="#q3" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：无法执行安装脚本。</p>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code>chmod<span class="w"> </span>+x<span class="w"> </span>install_*.sh
</code></pre></div>

<h2 id="_3">配置问题<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="q4-n_cores-n_configs_iter">Q4: n_cores 与 n_configs_iter 不匹配<a class="headerlink" href="#q4-n_cores-n_configs_iter" title="Permanent link">&para;</a></h3>
<p><strong>错误信息</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nx">Active</span><span class="w"> </span><span class="nx">learning</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="nx">only</span><span class="w"> </span><span class="nx">implemented</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">an</span><span class="w"> </span><span class="nx">multiple</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">number</span><span class="w"> </span><span class="nx">n_configs_iter</span><span class="p">.</span>
</code></pre></div>

<p><strong>原因</strong>：<code>n_cores</code> 必须是 <code>n_configs_iter</code> 的倍数。</p>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 确保 n_cores 是 n_configs_iter 的倍数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 10 是 5 的倍数，OK</span>

<span class="c1"># 或调整 n_configs_iter</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># 8 是 4 的倍数，OK</span>
</code></pre></div>

<h3 id="q5-orcagaussian">Q5: ORCA/Gaussian 未配置<a class="headerlink" href="#q5-orcagaussian" title="Permanent link">&para;</a></h3>
<p><strong>错误信息</strong>：</p>
<div class="highlight"><pre><span></span><code>ORCA keywords must be gradient
</code></pre></div>

<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 配置 ORCA</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="s1">&#39;def2-SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;EnGrad&#39;</span><span class="p">]</span>

<span class="c1"># 或配置 Gaussian</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">gaussian_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBEPBE&#39;</span><span class="p">,</span> <span class="s1">&#39;Def2SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;Force(NoStep)&#39;</span><span class="p">]</span>
</code></pre></div>

<h3 id="q6-mace-cuda">Q6: MACE CUDA 不可用<a class="headerlink" href="#q6-mace-cuda" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：MACE 无法使用 GPU。</p>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 CUDA</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="c1"># 如果不可用，使用 CPU</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
</code></pre></div>

<h2 id="_4">训练问题<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="q7">Q7: 训练过程中没有添加新构型<a class="headerlink" href="#q7" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：主动学习迭代多次，但训练数据集没有增长。</p>
<p><strong>可能原因</strong>：<br />
1. 选择方法阈值设置不当<br />
2. MLP 已经足够准确<br />
3. 温度过低，构型空间探索不足</p>
<p><strong>解决方案</strong>：<br />
1. 调整选择方法参数：<br />
   ```python<br />
   # 对于 AbsDiffE，降低阈值<br />
   selector = AbsDiffE(e_thresh=0.05)  # 从 0.1 降低到 0.05</p>
<p># 对于 AtomicEnvSimilarity，调整阈值<br />
   selector = AtomicEnvSimilarity(descriptor=desc, threshold=0.99)<br />
<code>2. 提高温度：</code>python<br />
   gap.al_train(method_name='orca', temp=1500)  # 从 1000 提高到 1500<br />
<code>3. 检查训练数据：</code>python<br />
   print(f"训练数据点数: {gap.n_train}")<br />
   ```</p>
<h3 id="q8">Q8: 训练时间过长<a class="headerlink" href="#q8" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：主动学习训练需要很长时间。</p>
<p><strong>解决方案</strong>：<br />
1. 减少迭代次数和构型数：<br />
<code>python
   gap.al_train(
       method_name='xtb',  # 使用更快的参考方法
       temp=1000,
       max_active_iters=10,  # 减少迭代次数
       n_configs_iter=5,     # 减少每次迭代的构型数
       max_active_time=500,  # 减少每次迭代的时间
   )</code><br />
2. 使用更快的参考方法（xTB 而不是 ORCA）<br />
3. 减少核心数（如果受内存限制）</p>
<h3 id="q9">Q9: 内存不足<a class="headerlink" href="#q9" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：训练过程中出现内存错误。</p>
<p><strong>解决方案</strong>：<br />
1. 减少并行核心数：<br />
<code>python
   mlt.Config.n_cores = 4  # 从 10 减少到 4</code><br />
2. 减少每次迭代的构型数：<br />
<code>python
   gap.al_train(..., n_configs_iter=5)  # 从 10 减少到 5</code><br />
3. 使用更小的系统进行测试</p>
<h2 id="md">MD 模拟问题<a class="headerlink" href="#md" title="Permanent link">&para;</a></h2>
<h3 id="q10">Q10: 能量不守恒<a class="headerlink" href="#q10" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：MD 模拟中能量不守恒。</p>
<p><strong>可能原因</strong>：<br />
1. 时间步长太大<br />
2. MLP 预测不准确<br />
3. 起始构型不合理</p>
<p><strong>解决方案</strong>：<br />
1. 减小时间步长：<br />
<code>python
   trajectory = mlt.md.run_mlp_md(..., dt=0.25)  # 从 0.5 减小到 0.25</code><br />
2. 重新训练 MLP，增加训练数据<br />
3. 使用能量最小化后的构型作为起始点</p>
<h3 id="q11">Q11: 模拟崩溃<a class="headerlink" href="#q11" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：MD 模拟中途崩溃。</p>
<p><strong>可能原因</strong>：<br />
1. 起始构型不合理<br />
2. 温度过高<br />
3. MLP 在未训练区域预测</p>
<p><strong>解决方案</strong>：<br />
1. 使用能量最低的构型：<br />
<code>python
   config = system.configuration  # 使用最低能量构型</code><br />
2. 降低温度：<br />
<code>python
   trajectory = mlt.md.run_mlp_md(..., temp=200)  # 从 300 降低到 200</code><br />
3. 增加训练数据覆盖范围：<br />
<code>python
   gap.al_train(..., temp=1500)  # 提高温度以探索更多区域</code></p>
<h3 id="q12-openmm-gpu">Q12: OpenMM 无法找到 GPU<a class="headerlink" href="#q12-openmm-gpu" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：OpenMM 无法使用 GPU。</p>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 明确指定使用 CPU</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md_openmm</span><span class="o">.</span><span class="n">run_mlp_md_openmm</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CPU&#39;</span><span class="p">)</span>

<span class="c1"># 或检查可用平台</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">openmm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Platform</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Platform</span><span class="o">.</span><span class="n">getPlatformByName</span><span class="p">(</span><span class="s1">&#39;CUDA&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isAvailable</span><span class="p">())</span>
</code></pre></div>

<h2 id="_5">高级采样问题<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="q13">Q13: 元动力学偏置增长过快<a class="headerlink" href="#q13" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：元动力学偏置增长过快，导致采样受限。</p>
<p><strong>解决方案</strong>：<br />
1. 使用良好调温元动力学：<br />
<code>python
   metad.bias_factor = 20.0  # 增加偏置因子</code><br />
2. 减小高斯高度：<br />
<code>python
   metad.height = 0.05  # 从 0.1 减小到 0.05</code><br />
3. 增加添加高斯的频率：<br />
<code>python
   metad.pace = 200  # 从 100 增加到 200</code></p>
<h3 id="q14">Q14: 伞形采样窗口重叠不足<a class="headerlink" href="#q14" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：伞形采样窗口之间重叠不足，导致自由能计算不准确。</p>
<p><strong>解决方案</strong>：<br />
1. 减小窗口间距：<br />
<code>python
   windows = [1.5, 1.7, 1.9, 2.1, 2.3]  # 从 0.5 间距减小到 0.2</code><br />
2. 增加弹簧常数：<br />
<code>python
   kappas = [0.2] * len(windows)  # 从 0.1 增加到 0.2</code><br />
3. 增加模拟时间：<br />
<code>python
   umbrella.run(..., fs=10000)  # 从 5000 增加到 10000</code></p>
<h2 id="_6">性能问题<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="q15">Q15: 计算速度慢<a class="headerlink" href="#q15" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：训练或模拟速度很慢。</p>
<p><strong>解决方案</strong>：<br />
1. 使用更快的参考方法（xTB 而不是 ORCA）<br />
2. 减少训练数据量（用于测试）<br />
3. 使用 GPU（MACE 模型）<br />
4. 优化并行设置：<br />
<code>python
   mlt.Config.n_cores = 16  # 根据系统调整</code></p>
<h3 id="q16">Q16: 内存使用过高<a class="headerlink" href="#q16" title="Permanent link">&para;</a></h3>
<p><strong>问题</strong>：内存使用过高，可能导致系统崩溃。</p>
<p><strong>解决方案</strong>：<br />
1. 减少并行核心数<br />
2. 减少批次大小（MACE）<br />
3. 使用更小的系统进行测试<br />
4. 定期清理不需要的数据</p>
<h2 id="_7">其他问题<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="q17">Q17: 如何查看训练进度？<a class="headerlink" href="#q17" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：<br />
训练过程中会输出日志信息，包括：<br />
- 当前迭代次数<br />
- 已添加的构型数<br />
- 训练数据集大小<br />
- 能量误差统计</p>
<p>您也可以检查训练数据：</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;训练数据点数: </span><span class="si">{</span><span class="n">gap</span><span class="o">.</span><span class="n">n_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="q18">Q18: 如何保存和加载模型？<a class="headerlink" href="#q18" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 保存（通常在训练时自动保存）</span>
<span class="n">gap</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># 加载</span>
<span class="n">gap</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</code></pre></div>

<h3 id="q19">Q19: 如何比较不同模型？<a class="headerlink" href="#q19" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用相同的测试轨迹</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">)</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">ace</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">)</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">mace</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="q20">Q20: 如何联系开发者？<a class="headerlink" href="#q20" title="Permanent link">&para;</a></h3>
<p><strong>解决方案</strong>：<br />
- <strong>GitHub Issues</strong>：https://github.com/duartegroup/mlp-train/issues<br />
- 查看项目 README 获取更多信息</p>
<h2 id="_8">获取帮助<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>如果以上问题都无法解决您的问题：</p>
<ol>
<li>查看 <a href="https://github.com/duartegroup/mlp-train/issues">GitHub Issues</a></li>
<li>阅读项目文档</li>
<li>查看示例代码</li>
<li>提交新的 Issue（包含错误信息和复现步骤）</li>
</ol>
<h2 id="_9">下一步<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<ul>
<li>查看 <a href="12_最佳实践.md">最佳实践</a> 优化您的使用</li>
<li>参考 <a href="09_示例教程.md">示例教程</a> 学习实际应用</li>
</ul>
            </section>

            <section id="section-11" class="section">
                <h1 id="_1">最佳实践<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<p>本章节提供使用 mlp-train 的最佳实践和建议，帮助您更高效地使用该包。</p>
<h2 id="_2">训练策略<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="1">1. 选择合适的模型<a class="headerlink" href="#1" title="Permanent link">&para;</a></h3>
<p>根据系统大小和精度要求选择模型：</p>
<ul>
<li><strong>小系统（&lt; 20 原子）</strong>：GAP 或 ACE</li>
<li><strong>中等系统（20-100 原子）</strong>：ACE 或 MACE</li>
<li><strong>大系统（&gt; 100 原子）</strong>：MACE（支持 GPU 加速）</li>
</ul>
<h3 id="2">2. 温度选择<a class="headerlink" href="#2" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>稳定结构</strong>：300-500 K</li>
<li><strong>反应路径探索</strong>：1000-2000 K</li>
<li><strong>过渡态</strong>：较低温度（100-300 K）</li>
</ul>
<h3 id="3">3. 选择方法<a class="headerlink" href="#3" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>简单系统</strong>：使用 <code>AbsDiffE</code>（默认）</li>
<li><strong>复杂系统</strong>：使用 <code>AtomicEnvSimilarity</code></li>
<li><strong>异常检测</strong>：使用 <code>AtomicEnvDistance</code></li>
</ul>
<h3 id="4">4. 迭代策略<a class="headerlink" href="#4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 快速测试</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span>      <span class="c1"># 使用快速方法</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">max_active_iters</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>     <span class="c1"># 少量迭代</span>
    <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>      <span class="c1"># 少量构型</span>
    <span class="n">max_active_time</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>   <span class="c1"># 短时间</span>
<span class="p">)</span>

<span class="c1"># 生产运行</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span>     <span class="c1"># 使用精确方法</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">1500</span><span class="p">,</span>
    <span class="n">max_active_iters</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>    <span class="c1"># 充分迭代</span>
    <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>     <span class="c1"># 足够构型</span>
    <span class="n">max_active_time</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>  <span class="c1"># 充分探索</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_3">性能优化<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="1_1">1. 并行设置<a class="headerlink" href="#1_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 确保 n_cores 是 n_configs_iter 的倍数</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>  <span class="c1"># 16 是 8 的倍数</span>

<span class="c1"># 根据系统资源调整</span>
<span class="c1"># CPU 密集型：n_cores = CPU 核心数</span>
<span class="c1"># 内存受限：减少 n_cores</span>
</code></pre></div>

<h3 id="2_1">2. 参考方法选择<a class="headerlink" href="#2_1" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>快速测试</strong>：xTB（秒级）</li>
<li><strong>平衡</strong>：ORCA PBE/def2-SVP（分钟级）</li>
<li><strong>高精度</strong>：ORCA PBE0/def2-TZVP（小时级）</li>
</ul>
<h3 id="3-gpu">3. GPU 加速<a class="headerlink" href="#3-gpu" title="Permanent link">&para;</a></h3>
<p>对于 MACE 模型，使用 GPU 可以显著加速：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 GPU 可用性</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">())</span>

<span class="c1"># 使用 GPU</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">mace_params</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cuda&#39;</span>
</code></pre></div>

<h2 id="_4">数据管理<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<h3 id="1_2">1. 保存训练数据<a class="headerlink" href="#1_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 训练后保存</span>
<span class="n">gap</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="c1"># 手动保存训练数据</span>
<span class="n">gap</span><span class="o">.</span><span class="n">training_data</span><span class="o">.</span><span class="n">save_xyz</span><span class="p">(</span><span class="s1">&#39;training_data.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_2">2. 检查训练质量<a class="headerlink" href="#2_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查训练数据量</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;训练数据点数: </span><span class="si">{</span><span class="n">gap</span><span class="o">.</span><span class="n">n_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 检查能量误差</span>
<span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">gap</span><span class="o">.</span><span class="n">training_data</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">true</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;能量误差: </span><span class="si">{</span><span class="n">error</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> eV&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="3_1">3. 数据清理<a class="headerlink" href="#3_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 移除高能构型</span>
<span class="n">gap</span><span class="o">.</span><span class="n">training_data</span><span class="o">.</span><span class="n">remove_above_e</span><span class="p">(</span><span class="n">max_e_threshold</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>

<span class="c1"># 移除未计算能量的构型</span>
<span class="k">if</span> <span class="n">gap</span><span class="o">.</span><span class="n">training_data</span><span class="o">.</span><span class="n">has_a_none_energy</span><span class="p">:</span>
    <span class="n">gap</span><span class="o">.</span><span class="n">training_data</span><span class="o">.</span><span class="n">remove_none_energy</span><span class="p">()</span>
</code></pre></div>

<h2 id="md">MD 模拟最佳实践<a class="headerlink" href="#md" title="Permanent link">&para;</a></h2>
<h3 id="1_3">1. 时间步长选择<a class="headerlink" href="#1_3" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>小分子</strong>：0.5 fs</li>
<li><strong>中等分子</strong>：1.0 fs</li>
<li><strong>大分子</strong>：2.0 fs（需谨慎测试）</li>
</ul>
<h3 id="2_3">2. 起始构型<a class="headerlink" href="#2_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 使用能量最低的构型</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">configuration</span>

<span class="c1"># 或使用能量最小化后的构型</span>
<span class="c1"># （需要额外的能量最小化步骤）</span>
</code></pre></div>

<h3 id="3_2">3. 温度控制<a class="headerlink" href="#3_2" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 逐步升温</span>
<span class="n">trajectory1</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>   <span class="c1"># 低温平衡</span>
<span class="n">trajectory2</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>   <span class="c1"># 目标温度</span>
</code></pre></div>

<h3 id="4_1">4. 保存频率<a class="headerlink" href="#4_1" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 短时间模拟：频繁保存</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># 长时间模拟：减少保存频率</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</code></pre></div>

<h2 id="_5">高级采样最佳实践<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="1_4">1. 元动力学<a class="headerlink" href="#1_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 选择合适的 CV</span>
<span class="c1"># - CV 应该能够区分不同状态</span>
<span class="c1"># - 避免使用快变量</span>

<span class="c1"># 自动估计参数</span>
<span class="n">metad</span><span class="o">.</span><span class="n">estimate_width</span><span class="p">(</span><span class="n">configurations</span><span class="o">=</span><span class="n">config_set</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">)</span>

<span class="c1"># 使用良好调温元动力学</span>
<span class="n">metad</span><span class="o">.</span><span class="n">bias_factor</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># 根据系统调整</span>
</code></pre></div>

<h3 id="2_4">2. 伞形采样<a class="headerlink" href="#2_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 窗口间距：确保足够重叠</span>
<span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.7</span><span class="p">]</span>  <span class="c1"># 0.3 间距</span>

<span class="c1"># 弹簧常数：足够大但不过大</span>
<span class="n">kappas</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>

<span class="c1"># 模拟时间：确保充分采样</span>
<span class="n">umbrella</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div>

<h2 id="_6">代码组织<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="1_5">1. 模块化<a class="headerlink" href="#1_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># config.py - 配置管理</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">orca_keywords</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="s1">&#39;def2-SVP&#39;</span><span class="p">,</span> <span class="s1">&#39;EnGrad&#39;</span><span class="p">]</span>

<span class="c1"># train.py - 训练脚本</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="c1"># ... 训练代码 ...</span>

<span class="c1"># md.py - MD 模拟脚本</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">config</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="c1"># ... MD 代码 ...</span>
</code></pre></div>

<h3 id="2_5">2. 错误处理<a class="headerlink" href="#2_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;orca&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;训练失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># 保存已有数据</span>
    <span class="n">gap</span><span class="o">.</span><span class="n">training_data</span><span class="o">.</span><span class="n">save_xyz</span><span class="p">(</span><span class="s1">&#39;partial_training_data.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="3_3">3. 日志记录<a class="headerlink" href="#3_3" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">handlers</span><span class="o">=</span><span class="p">[</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;training.log&#39;</span><span class="p">),</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="_7">验证和测试<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="1_6">1. 小规模测试<a class="headerlink" href="#1_6" title="Permanent link">&para;</a></h3>
<p>在运行大规模计算前，先进行小规模测试：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 测试脚本</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span>
    <span class="n">method_name</span><span class="o">=</span><span class="s1">&#39;xtb&#39;</span><span class="p">,</span>      <span class="c1"># 快速方法</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">max_active_iters</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>     <span class="c1"># 少量迭代</span>
    <span class="n">n_configs_iter</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>      <span class="c1"># 少量构型</span>
    <span class="n">max_active_time</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>   <span class="c1"># 短时间</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="2_6">2. 验证训练结果<a class="headerlink" href="#2_6" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 运行短时间 MD 验证</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="n">configuration</span><span class="o">=</span><span class="n">system</span><span class="o">.</span><span class="n">random_configuration</span><span class="p">(),</span>
    <span class="n">mlp</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span>
    <span class="n">fs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>         <span class="c1"># 短时间</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">dt</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># 比较预测与真实值</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="s1">&#39;orca&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="3_4">3. 检查能量守恒<a class="headerlink" href="#3_4" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 检查 NVE 模拟的能量守恒</span>
<span class="n">trajectory</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">run_mlp_md</span><span class="p">(</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># NVE 模拟</span>
<span class="p">)</span>

<span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">predicted</span> <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">trajectory</span><span class="p">]</span>
<span class="n">energy_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;能量标准差: </span><span class="si">{</span><span class="n">energy_std</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2"> eV&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_8">资源管理<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<h3 id="1_7">1. 内存管理<a class="headerlink" href="#1_7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 定期清理不需要的数据</span>
<span class="k">del</span> <span class="n">old_trajectory</span>
<span class="k">del</span> <span class="n">old_config_set</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
<span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</code></pre></div>

<h3 id="2_7">2. 磁盘空间<a class="headerlink" href="#2_7" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 只保存必要的文件</span>
<span class="n">trajectory</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;important_trajectory.xyz&#39;</span><span class="p">)</span>

<span class="c1"># 删除中间文件</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;temp_file.xyz&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="3_5">3. 计算资源<a class="headerlink" href="#3_5" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 根据可用资源调整</span>
<span class="c1"># - CPU 核心数</span>
<span class="c1"># - 内存大小</span>
<span class="c1"># - GPU 可用性</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">n_cores</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
</code></pre></div>

<h2 id="_9">调试技巧<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<h3 id="1_8">1. 逐步调试<a class="headerlink" href="#1_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. 检查系统创建</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Molecule</span><span class="p">(</span><span class="s1">&#39;water.xyz&#39;</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;系统原子数: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 2. 检查 MLP 创建</span>
<span class="n">gap</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">potentials</span><span class="o">.</span><span class="n">GAP</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="n">system</span><span class="o">=</span><span class="n">system</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MLP 名称: </span><span class="si">{</span><span class="n">gap</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 3. 检查训练数据</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;初始训练数据: </span><span class="si">{</span><span class="n">gap</span><span class="o">.</span><span class="n">n_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># 4. 逐步训练</span>
<span class="n">gap</span><span class="o">.</span><span class="n">al_train</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">max_active_iters</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 先运行一次迭代</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;训练后数据: </span><span class="si">{</span><span class="n">gap</span><span class="o">.</span><span class="n">n_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="2_8">2. 可视化<a class="headerlink" href="#2_8" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 绘制能量分布</span>
<span class="n">energies</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">true</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">gap</span><span class="o">.</span><span class="n">training_data</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">true</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Energy (eV)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;energy_distribution.png&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_10">文档和记录<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<h3 id="1_9">1. 记录参数<a class="headerlink" href="#1_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 在脚本中记录重要参数</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">训练参数：</span>
<span class="sd">- 模型：GAP</span>
<span class="sd">- 参考方法：ORCA PBE/def2-SVP</span>
<span class="sd">- 温度：1000 K</span>
<span class="sd">- 迭代次数：50</span>
<span class="sd">- 选择方法：AbsDiffE (e_thresh=0.1)</span>
<span class="sd">&quot;&quot;&quot;</span>
</code></pre></div>

<h3 id="2_9">2. 版本控制<a class="headerlink" href="#2_9" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 记录使用的版本</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mlptrain</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlt</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mlp-train 版本: </span><span class="si">{</span><span class="n">mlt</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2 id="_11">常见陷阱<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<h3 id="1_10">1. 避免过度训练<a class="headerlink" href="#1_10" title="Permanent link">&para;</a></h3>
<ul>
<li>不要无限制地增加训练数据</li>
<li>监控验证误差，避免过拟合</li>
</ul>
<h3 id="2_10">2. 避免温度过高<a class="headerlink" href="#2_10" title="Permanent link">&para;</a></h3>
<ul>
<li>过高的温度可能导致不合理的构型</li>
<li>根据系统特性选择合适的温度</li>
</ul>
<h3 id="3_6">3. 避免参数不当<a class="headerlink" href="#3_6" title="Permanent link">&para;</a></h3>
<ul>
<li>确保所有参数设置合理</li>
<li>参考示例和文档</li>
</ul>
<h2 id="_12">总结<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<p>遵循这些最佳实践可以帮助您：</p>
<ol>
<li><strong>提高效率</strong>：优化计算资源使用</li>
<li><strong>保证质量</strong>：确保训练和模拟的准确性</li>
<li><strong>便于维护</strong>：组织良好的代码易于维护和扩展</li>
<li><strong>减少错误</strong>：避免常见陷阱和问题</li>
</ol>
<h2 id="_13">下一步<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h2>
<ul>
<li>查看 <a href="10_API参考.md">API 参考</a> 了解详细 API</li>
<li>参考 <a href="09_示例教程.md">示例教程</a> 学习实际应用</li>
<li>遇到问题时查看 <a href="11_常见问题.md">常见问题</a></li>
</ul>
            </section>

        </main>
    </div>
    
    <script src="script.js"></script>
</body>
</html>